#!/bin/bash
# =========================================
# Script Renew SSH | Fixed System User
# =========================================
clear
# Warna
red() { echo -e "\\033[32;1m${*}\\033[0m"; }
BlueCyan='\e[5;36m'
NC='\e[0m'

# Validasi Izin
checking_sc() {
    if [[ ! -f "/usr/bin/user" ]]; then echo "admin" > /usr/bin/user; echo "2099-12-31" > /usr/bin/e; fi
}
checking_sc

# Variabel
nama=$(cat /etc/xray/username 2>/dev/null)

# Fungsi Banner
function baris_panjang() { echo -e "\033[5;36m ◇━━━━━━━━━━━━━━━━━◇ \033[0m"; }
function Xwan_Banner() {
    clear
    baris_panjang
    echo -e "\033[95;1m     $nama       \033[0m"
    baris_panjang
}

function Sc_Credit(){
    sleep 1
    baris_panjang
    echo -e "\033[2;35m      User Berhasil Diperpanjang \033[0m"
    echo -e "\033[2;35m           $nama  \033[0m"
    baris_panjang
    exit 0
}

Xwan_Banner
echo -e "     RENEW USER SSH"
baris_panjang
echo -e "No  | User         | Expired"
baris_panjang

# --- LIST USER SYSTEM ---
no=1
users=()
exps=()

while IFS=: read -r username _ uid _ _ _ _; do
    if [[ $uid -ge 1000 && "$username" != "nobody" ]]; then
        exp_date_raw=$(chage -l "$username" | grep "Account expires" | cut -d: -f2 | sed 's/^ //g')
        if [[ -z "$exp_date_raw" || "$exp_date_raw" == "never" ]]; then
            exp_date="Unlimited"
        else
            exp_date=$(date -d "$exp_date_raw" +"%Y-%m-%d" 2>/dev/null)
        fi
        
        printf " [%-2d] %-15s %s\n" "$no" "$username" "$exp_date"
        users+=("$username")
        exps+=("$exp_date")
        ((no++))
    fi
done < /etc/passwd

baris_panjang
echo ""
read -p " Pilih Nomor User : " client_number
echo ""

if ! [[ "$client_number" =~ ^[0-9]+$ ]]; then echo -e "\033[91mInput salah!\033[0m"; exit 1; fi

index=$((client_number - 1))
user="${users[$index]}"
current_exp="${exps[$index]}"

if [[ -z "$user" ]]; then echo -e "\033[91mUser tidak valid!\033[0m"; exit 1; fi

# Input Data Baru
read -p " Tambah Masa Aktif (Hari): " masaaktif
read -p " Limit User (IP)         : " iplim

# Hitung Expired Baru
now=$(date +%Y-%m-%d)
# Jika unlimited atau error, mulai hitung dari hari ini
if [[ "$current_exp" == "Unlimited" || -z "$current_exp" ]]; then
    d1=$(date -d "$now" +%s)
else
    d1=$(date -d "$current_exp" +%s)
fi

d2=$(date -d "$now" +%s)
# Pastikan tidak minus
if [[ $d1 -lt $d2 ]]; then d1=$d2; fi

exp_seconds=$(($d1 + ($masaaktif * 86400)))
new_exp_date=$(date -d "@$exp_seconds" +"%Y-%m-%d")

# --- PROSES RENEW ---

# 1. Update Expired System User
usermod -e "$new_exp_date" "$user"

# 2. Update Database SSH (Untuk catatan script)
# Format DB: #ssh# user pass quota iplimit exp
# Kita hanya update tanggal expired jika user ada di DB
if grep -q "^#ssh# $user" /etc/ssh/.ssh.db; then
    sed -i "s/\(^#ssh# $user .* \)[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}$/\1$new_exp_date/" /etc/ssh/.ssh.db
fi

# 3. Update Limit IP
if [[ -n "$iplim" ]]; then
    mkdir -p /etc/kyt/limit/ssh/ip
    echo "$iplim" > /etc/kyt/limit/ssh/ip/$user
    
    # Update di DB juga jika ada kolom limit ip
    # (Opsional, tergantung struktur DB Anda, tapi line di atas sudah cukup untuk limiter)
fi

# Tampilan Sukses
clear
baris_panjang
echo -e " SSH RENEW SUCCESS"
baris_panjang
echo -e " Client    : $user"
echo -e " Expired   : $new_exp_date"
echo -e " Add Days  : $masaaktif Days"
Sc_Credit