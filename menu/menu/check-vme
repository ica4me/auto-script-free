#!/bin/bash
clear

yellow="\033[0;33m"
ungu="\033[0;35m"
Red="\033[91;1m"
Xark="\033[0m"
BlueCyan="\033[5;36m"
WhiteBe="\033[5;37m"
GreenBe="\033[5;32m"
YellowBe="\033[5;33m"
BlueBe="\033[5;34m"
nama=$(cat /etc/xray/username)

# . Liner 
function baris_panjang() {
  echo -e "${ungu} ——————————————————————————————————— ${Xark} "
}

function Xwan_Banner() {
clear
baris_panjang
echo -e "${BlueCyan}           $nama      ${Xark} "
baris_panjang
}
function Sc_Credit(){
sleep 1
baris_panjang
echo -e "${BlueCyan}  Terimakasih Telah Menggunakan ${Xark}"
echo -e "${BlueCyan}          Script Credit ${Xark}"
echo -e "${BlueCyan}          $nama ${Xark}"
baris_panjang
echo ""
read -rp "press any key for back"
m-xray
}

duration=3
frames=("██10%" "█████35%" "█████████65%" "█████████████80%" "█████████████████████90%" "█████████████████████████100%")

Loading_Animasi() {
    for ((i = 0; i < duration; i++)); do
        clear
        index=$((i % ${#frames[@]}))
        color_code=$((31 + i % 7))
        echo -e "\n\n\n\e[1;${color_code}m ${frames[$index]}\e[0m"
        sleep 0.5
    done
}

Loading_Succes() {
clear
echo -e  "\033[5;32mSucces\033[0m"
sleep 2
clear
}

# ===================== PILIH USER DARI NOMOR ===================== #
function Pilih_User() {
    clients=($(grep -E "^### " "/etc/xray/config.json" | cut -d ' ' -f 2 | sort | uniq))
    if [[ ${#clients[@]} -eq 0 ]]; then
        echo -e "${Red}Tidak ada client terdaftar${Xark}"
        Sc_Credit
    fi
    
    echo ""
    baris_panjang
    echo -e "     ${BlueCyan} DAFTAR MEMBER VMESS ${Xark}"
    baris_panjang
    for i in "${!clients[@]}"; do
        exp=$(grep -E "^### ${clients[$i]} " "/etc/xray/config.json" | cut -d ' ' -f 3)
        echo -e " $((i+1)). ${clients[$i]}"
    done
    baris_panjang
    echo ""
    read -rp "Pilih nomor user: " num
    
    if [[ -z $num || $num -lt 1 || $num -gt ${#clients[@]} ]]; then
        echo -e "${Red}Pilihan tidak valid!${Xark}"
        Sc_Credit
    fi
    
    user=${clients[$((num-1))]}
}

# ===================== DETAIL CONFIG ===================== #
function Cek_Config_Vmess() {
CITY=$(cat /etc/xray/city)
ISP=$(cat /etc/xray/isp)
domain=$(cat /etc/xray/domain)
iplimit=$(cat /etc/kyt/limit/vmess/ip/$user 2>/dev/null)
Quota1=$(cat /etc/vmess/$user 2>/dev/null)
Quota=$((Quota1 / 1024 / 1024 / 1024))
uuid=$(grep -E "^},{" "/etc/xray/config.json" | grep -i "\"$user\"" | cut -d '"' -f 4 | uniq)
exp=$(grep -E "^### $user " "/etc/xray/config.json" | cut -d ' ' -f 3 | uniq)

asu=$(cat<<EOF
{"v":"2","ps":"$user","add":"$domain","port":"443","id":"$uuid","aid":"0","net":"ws","path":"/vmess","type":"none","host":"$domain","tls":"tls"}
EOF
)
ask=$(cat<<EOF
{"v":"2","ps":"$user","add":"$domain","port":"80","id":"$uuid","aid":"0","net":"ws","path":"/vmess","type":"none","host":"$domain","tls":"none"}
EOF
)
grpc=$(cat<<EOF
{"v":"2","ps":"$user","add":"$domain","port":"443","id":"$uuid","aid":"0","net":"grpc","path":"vmess-grpc","type":"none","host":"$domain","tls":"tls"}
EOF
)

vmesslink1="vmess://$(echo $asu | base64 -w 0)"
vmesslink2="vmess://$(echo $ask | base64 -w 0)"
vmesslink3="vmess://$(echo $grpc | base64 -w 0)"
}

Details_Account() {
baris_panjang
echo -e "\033[37m VMESS XRAY \033[0m"
baris_panjang
echo -e " Remarks       : ${user}"
echo -e " Domain        : ${domain}"
echo -e " User Quota    : ${Quota} GB"
echo -e " User Ip       : ${iplimit} IP"
echo -e " Key           : ${uuid}"
echo -e " ISP           : $ISP"
echo -e " City          : $CITY"
baris_panjang
}

Link_Json() {
baris_panjang
echo -e " Link TLS      : ${vmesslink1}"
baris_panjang
echo -e " Link WS       : ${vmesslink2}"
baris_panjang
echo -e " Link GRPC     : ${vmesslink3}"
baris_panjang
echo -e " OpenClash     : https://${domain}:81/vmess-$user.txt"
baris_panjang
}

Details_Expiry() {
echo -e "\033[33m Expiry        : $exp \033[0m"
baris_panjang
}

# ===================== MAIN ===================== #
Xwan_Banner
Pilih_User
clear
Loading_Animasi
Loading_Succes
Cek_Config_Vmess
Details_Account
Link_Json
Details_Expiry
Sc_Credit
