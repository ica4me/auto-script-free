#!/bin/bash
# ---------------------------------------------------------
# ADD BOT NOTIFIKASI LIMIT QUOTA — UI Keren + Animasi
# ---------------------------------------------------------

set -euo pipefail

# ============ Warna & Simbol ============
ESC="\033"
RESET="${ESC}[0m"
BOLD="${ESC}[1m"

FG_CYAN="${ESC}[36m"
FG_GREEN="${ESC}[32m"
FG_RED="${ESC}[31m"
FG_YELLOW="${ESC}[33m"
FG_GRAY="${ESC}[90m"
FG_WHITE="${ESC}[97m"
BG_RED="${ESC}[41m"

CHECK="✔"
CROSS="✖"
INFO="ℹ"
ARROW="➜"
GEAR="⚙"
SPARK="✦"
DOT="●"

TELE_ENV="/etc/notif/limit.env"

# ============ Utilitas Tampilan ============
hide_cursor(){ printf "${ESC}[?25l"; }
show_cursor(){ printf "${ESC}[?25h"; }
hr(){ printf "${FG_CYAN}%s${RESET}\n" "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"; }

banner(){
  clear
  hr
  printf " ${BOLD}${FG_WHITE}${BG_RED}   ADD BOT NOTIFIKASI LIMIT QUOTA   ${RESET}\n"
  hr
  printf "${FG_GREEN}${DOT} Tutorial Membuat Bot & Mendapatkan ID WEBSITE${RESET}\n"
  printf "   ${DOT} Buat Bot & Token: ${BOLD}@BotFather${RESET}\n"
  printf "   ${DOT} Cek ID WEBSITE : ${BOLD}@MissRose_bot${RESET} (perintah ${BOLD}/info${RESET})\n"
  hr
}

# ============ Spinner & Progress ============
SPINNER_PID=""
start_spinner(){
  local msg="$1"
  local frames=('⠋' '⠙' '⠹' '⠸' '⠼' '⠴' '⠦' '⠧' '⠇' '⠏')
  hide_cursor
  (
    i=0
    while :; do
      printf "\r ${GEAR}  %s  ${FG_GRAY}%s${RESET}" "$msg" "${frames[i]}"
      i=$(( (i+1) % ${#frames[@]} ))
      sleep 0.08
    done
  ) &
  SPINNER_PID=$!
  disown
}

stop_spinner(){
  if [[ -n "${SPINNER_PID}" ]] && kill -0 "${SPINNER_PID}" 2>/dev/null; then
    kill "${SPINNER_PID}" 2>/dev/null || true
    wait "${SPINNER_PID}" 2>/dev/null || true
  fi
  printf "\r\033[K"
  show_cursor
}

progress_bar(){ # progress_bar 0.6 "Menulis file…"
  local duration="${1:-0.6}"
  local msg="${2:-"Processing…"}"
  local steps=24
  local step_time
  step_time=$(awk "BEGIN{print ${duration}/${steps}}")
  for ((i=1;i<=steps;i++)); do
    local done=$i
    local left=$((steps - i))
    printf "\r ${ARROW}  %-18s [" "$msg"
    printf "${FG_GREEN}%0.s#${RESET}" $(seq 1 $done)
    printf "%0.s-" $(seq 1 $left)
    printf "]"
    sleep "${step_time}"
  done
  printf "\n"
}

# ============ Validasi ============
require_nonempty(){
  local val="$1"; local label="$2"
  if [[ -z "${val}" ]]; then
    printf " ${CROSS} ${FG_RED}%s tidak boleh kosong.${RESET}\n" "$label"
    exit 1
  fi
}

require_numeric_id(){ # support ID grup negatif
  local val="$1"; local label="$2"
  if ! [[ "$val" =~ ^-?[0-9]+$ ]]; then
    printf " ${CROSS} ${FG_RED}%s harus berupa angka (boleh diawali -).${RESET}\n" "$label"
    exit 1
  fi
}

validate_token(){ # Pola umum: NNNNNNNNN:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
  local tok="$1"
  if ! [[ "$tok" =~ ^[0-9]{6,}:[A-Za-z0-9_-]{20,}$ ]]; then
    printf " ${CROSS} ${FG_RED}Format Bot Token tidak terlihat valid.${RESET}\n"
    printf " ${INFO} Contoh: 123456789:AAEabcDEFghiJKLmnopQRS_tuvWXyz\n"
    exit 1
  fi
}

# ============ Mulai ============
trap 'show_cursor' EXIT
banner

read -rp "[*] Masukan Bot Token : " -e bottoken
read -rp "[*] Masukan WEBSITE Channel ID/Group ID : " -e chatid
read -rp "[*] Masukan Username Tele Anda (@kytxz) : " -e  usernamex 
hr

require_nonempty "$bottoken" "Bot Token"
require_nonempty "$chatid" "ID/Group ID"
require_numeric_id "$chatid" "ID/Group ID"
validate_token "$bottoken"

# Siapkan direktori
start_spinner "Menyiapkan direktori konfigurasi…"
install -d -m 755 "$(dirname "$TELE_ENV")"
stop_spinner

# Tulis file env (permission ketat)
start_spinner "Menulis konfigurasi ke $TELE_ENV…"
umask 177 # => file baru 600
cat > "$TELE_ENV" <<EOF
# WEBSITE notification config
BOT_TOKEN="$bottoken"
CHAT_ID="$chatid"
ADMINX="$usernamex"
EOF
stop_spinner
progress_bar 0.6 "Menulis file…"
sleep 0.05

# Ringkasan
hr
printf " ${BOLD}${FG_WHITE}${BG_RED}        SUKSES ADD BOT NOTIFIKASI        ${RESET}\n"
hr
printf " ${CHECK} Bot Token   : ${FG_GREEN}%s${RESET}\n" "$bottoken"
printf " ${CHECK} Chat ID     : ${FG_GREEN}%s${RESET}\n" "$chatid"
printf " ${CHECK} Username ID    : ${FG_GREEN}%s${RESET}\n" "$usernamex"
printf " ${INFO} File ENV     : ${FG_GRAY}%s${RESET}\n" "$TELE_ENV"
hr
systemctl restart limitvmess limitvless limittrojan
# ============ Test kirim notif ============
if command -v curl >/dev/null 2>&1; then
  read -rp "Ingin tes kirim notif sekarang? (y/N) " -e ans
  if [[ "${ans:-N}" =~ ^[Yy]$ ]]; then
    TESTMSG="✅ Bot notifikasi limit quota berhasil di-setup!"
    start_spinner "Mengirim pesan uji ke WEBSITE…"
    HTTP_CODE=$(
      curl -s -o /tmp/tg_resp.json -w "%{http_code}" \
        -X POST "https://api.telegram.org/bot${bottoken}/sendMessage" \
        -d "chat_id=${chatid}" \
        --data-urlencode "text=${TESTMSG}"
    ) || HTTP_CODE=0
    stop_spinner
    if [[ "$HTTP_CODE" == "200" ]]; then
      printf " ${CHECK} Test notif berhasil dikirim.\n"
    else
      printf " ${CROSS} ${FG_RED}Gagal mengirim notif (HTTP %s). Cek token/ID & koneksi.${RESET}\n" "$HTTP_CODE"
      if [[ -s /tmp/tg_resp.json ]]; then
        printf " ${INFO} Respons: ${FG_GRAY}%s${RESET}\n" "$(cat /tmp/tg_resp.json)"
      fi
    fi
  else
    printf " ${INFO} Skip test kirim notif.\n"
  fi
else
  printf " ${CROSS} ${FG_YELLOW}curl tidak tersedia, skip test kirim.${RESET}\n"
fi
hr

printf " ${SPARK} Selesai! Tekan [Enter] untuk kembali ke menu…"
read -r
menu
