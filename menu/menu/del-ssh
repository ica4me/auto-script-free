#!/bin/bash
# =========================================
# Script Delete SSH | Fixed System User
# =========================================
clear
# Warna
red() { echo -e "\\033[32;1m${*}\\033[0m"; }
BlueCyan='\e[5;36m'
NC='\e[0m'

# Validasi Izin
checking_sc() {
    if [[ ! -f "/usr/bin/user" ]]; then echo "admin" > /usr/bin/user; echo "2099-12-31" > /usr/bin/e; fi
}
checking_sc

# Variabel
nama=$(cat /etc/xray/username 2>/dev/null)

# Fungsi Banner
function baris_panjang() { echo -e "\033[5;36m ◇━━━━━━━━━━━━━━━━━◇ \033[0m"; }
function Xwan_Banner() {
    clear
    baris_panjang
    echo -e "\033[95;1m     $nama       \033[0m"
    baris_panjang
}

function Sc_Credit(){
    sleep 1
    baris_panjang
    echo -e "\033[2;35m      Terimakasih Telah Menggunakan \033[0m"
    echo -e "\033[2;35m             Script Credit \033[0m"
    echo -e "\033[2;35m           $nama  \033[0m"
    baris_panjang
    exit 0
}

Xwan_Banner
echo -e "     LIST USER SSH"
baris_panjang
echo -e "No  | User         | Expired"
baris_panjang

# --- LOGIKA LIST USER SYSTEM ---
# Mengambil user dengan UID >= 1000 (User biasa, bukan sistem)
no=1
users=()
exps=()

while IFS=: read -r username _ uid _ _ _ _; do
    if [[ $uid -ge 1000 && "$username" != "nobody" ]]; then
        # Ambil tanggal expired dari chage
        exp_date=$(chage -l "$username" | grep "Account expires" | cut -d: -f2 | sed 's/^ //g')
        
        if [[ -z "$exp_date" || "$exp_date" == "never" ]]; then
            exp_date="Unlimited"
        else
            # Format tanggal agar lebih rapi
            exp_date=$(date -d "$exp_date" +"%Y-%m-%d" 2>/dev/null)
        fi
        
        printf " [%-2d] %-15s %s\n" "$no" "$username" "$exp_date"
        users+=("$username")
        exps+=("$exp_date")
        ((no++))
    fi
done < /etc/passwd

baris_panjang
echo ""
read -p " Pilih Nomor User untuk dihapus : " client_number
echo ""

# Validasi Input
if ! [[ "$client_number" =~ ^[0-9]+$ ]]; then
    echo -e "\033[91m Input harus angka! \033[0m"
    exit 1
fi

# Ambil user dari array (index dimulai dari 0, input mulai dari 1)
index=$((client_number - 1))
user="${users[$index]}"
exp="${exps[$index]}"

if [[ -z "$user" ]]; then
    echo -e "\033[91m User tidak ditemukan! \033[0m"
    exit 1
fi

echo -e " Menghapus User SSH : $user ..."

# --- PROSES PENGHAPUSAN ---

# 1. Hapus User System (Paksa hapus meski sedang login)
userdel -f "$user"

# 2. Hapus dari Database SSH (Backup file)
sed -i "/^#ssh# $user /d" /etc/ssh/.ssh.db

# 3. Hapus File Limit IP (Jika ada)
rm -f /etc/kyt/limit/ssh/ip/$user

echo -e " \033[32mUser SSH berhasil dihapus! \033[0m"
Sc_Credit