#!/bin/bash
# =========================================
# Script Renew VLESS | Fixed for JSON v2
# =========================================
clear
# Warna
red() { echo -e "\\033[32;1m${*}\\033[0m"; }
BlueCyan='\e[5;36m'
NC='\e[0m'

# Validasi Izin
checking_sc() {
    if [[ ! -f "/usr/bin/user" ]]; then echo "admin" > /usr/bin/user; echo "2099-12-31" > /usr/bin/e; fi
}
checking_sc

# Variabel
nama=$(cat /etc/xray/username 2>/dev/null)

# Fungsi Banner
function baris_panjang() { echo -e "\033[5;36m ◇━━━━━━━━━━━━━━━━━◇ \033[0m"; }
function Xwan_Banner() {
    clear
    baris_panjang
    echo -e "\033[95;1m     $nama       \033[0m"
    baris_panjang
}

function Sc_Credit(){
    sleep 1
    baris_panjang
    echo -e "\033[2;35m      User Berhasil Diperpanjang \033[0m"
    echo -e "\033[2;35m           $nama  \033[0m"
    baris_panjang
    exit 0
}

# --- LOGIKA BARU ---
if [[ ! -f "/etc/vless/.vless.db" ]]; then
    Xwan_Banner
    echo -e "\033[91m Database Kosong! \033[0m"
    exit 0
fi

NUMBER_OF_CLIENTS=$(grep -c -E "^### " "/etc/vless/.vless.db")
if [[ ${NUMBER_OF_CLIENTS} == '0' ]]; then
    Xwan_Banner
    echo -e "\033[91m Tidak ada user untuk diperpanjang! \033[0m"
    exit 0
fi

Xwan_Banner
echo -e "     RENEW USER VLESS"
baris_panjang
echo -e "No  | User         | Expired"
baris_panjang
grep -E "^### " "/etc/vless/.vless.db" | cut -d ' ' -f 2-3 | nl -s ') '
baris_panjang

read -p " Pilih Nomor User : " client_number
echo ""

if ! [[ "$client_number" =~ ^[0-9]+$ ]]; then echo -e "\033[91mInput salah!\033[0m"; exit 1; fi

user=$(grep -E "^### " "/etc/vless/.vless.db" | cut -d ' ' -f 2 | sed -n "${client_number}p")
exp=$(grep -E "^### " "/etc/vless/.vless.db" | cut -d ' ' -f 3 | sed -n "${client_number}p")

if [[ -z "$user" ]]; then echo -e "\033[91mUser tidak valid!\033[0m"; exit 1; fi

# Input Data Baru
read -p " Tambah Masa Aktif (Hari): " masaaktif
read -p " Limit User (GB)         : " Quota
read -p " Limit User (IP)         : " iplim

# Hitung Expired Baru
now=$(date +%Y-%m-%d)
d1=$(date -d "$exp" +%s)
d2=$(date -d "$now" +%s)
exp2=$(( (d1 - d2) / 86400 ))
exp3=$(($exp2 + $masaaktif))
exp4=`date -d "$exp3 days" +"%Y-%m-%d"`

# --- UPDATE DATABASE ---
sed -i "s/### $user $exp/### $user $exp4/g" /etc/vless/.vless.db

# Update Limit IP
if [[ -n "$iplim" ]]; then
    mkdir -p /etc/kyt/limit/vless/ip
    echo "$iplim" > /etc/kyt/limit/vless/ip/$user
fi

# Update Limit Quota
if [[ -n "$Quota" ]]; then
    c=$(echo "${Quota}" | sed 's/[^0-9]*//g')
    d=$((${c} * 1024 * 1024 * 1024))
    if [[ ${c} != "0" ]]; then
        echo "${d}" >/etc/vless/${user}
    fi
fi

# Tampilan Sukses
clear
baris_panjang
echo -e " VLESS RENEW SUCCESS"
baris_panjang
echo -e " Client    : $user"
echo -e " Expired   : $exp4"
echo -e " Add Days  : $masaaktif Days"
Sc_Credit