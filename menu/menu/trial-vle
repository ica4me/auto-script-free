#!/bin/bash
# =========================================
# Script Trial VLESS | Fixed for JSON v2
# =========================================
clear
# Warna
BlueCyan='\e[5;36m'
NC='\e[0m'
WhiteBe='\e[5;37m'

# Validasi Izin
checking_sc() {
    if [[ ! -f "/usr/bin/user" ]]; then echo "admin" > /usr/bin/user; echo "2099-12-31" > /usr/bin/e; fi
}
checking_sc

# Variabel
domain=$(cat /etc/xray/domain)
nama=$(cat /etc/xray/username)
user="TRIAL-VLE-$($(od -An -N2 -i /dev/urandom) % 10000))"
uuid=$(cat /proc/sys/kernel/random/uuid)
masaaktif=1 # Default 1 hari atau sesuaikan menit
exp=$(date -d "$masaaktif days" +"%Y-%m-%d")

# --- PROSES INJEKSI (TAHAP 2 SYNC) ---
sed -i "/#vless$/i ,{\"id\": \"$uuid\",\"email\": \"$user\"}" /etc/xray/config.json
sed -i "/#vlessgrpc$/i ,{\"id\": \"$uuid\",\"email\": \"$user\"}" /etc/xray/config.json

systemctl restart xray

# Simpan ke Database (Agar terbaca script Check & Delete)
echo "### $user $exp $uuid" >> /etc/vless/.vless.db

# Generate Links
vlesslink1="vless://${uuid}@${domain}:443?path=/vless&security=tls&encryption=none&type=ws#${user}"
vlesslink2="vless://${uuid}@${domain}:80?path=/vless&encryption=none&type=ws#${user}"
vlesslink3="vless://${uuid}@${domain}:443?mode=gun&security=tls&encryption=none&type=grpc&serviceName=vless-grpc&sni=${domain}#${user}"

clear
echo -e "${BlueCyan}◇━━━━━━━━━━━━━━━━━◇${NC}"
echo -e "    VLESS TRIAL"
echo -e "${BlueCyan}◇━━━━━━━━━━━━━━━━━◇${NC}"
echo -e " Remarks   : $user"
echo -e " Domain    : $domain"
echo -e " UUID      : $uuid"
echo -e " Expired   : $exp"
echo -e "${BlueCyan}◇━━━━━━━━━━━━━━━━━◇${NC}"
echo -e " TLS       : $vlesslink1"
echo -e "${BlueCyan}◇━━━━━━━━━━━━━━━━━◇${NC}"
echo -e " NTLS      : $vlesslink2"
echo -e "${BlueCyan}◇━━━━━━━━━━━━━━━━━◇${NC}"
echo -e " GRPC      : $vlesslink3"
echo -e "${BlueCyan}◇━━━━━━━━━━━━━━━━━◇${NC}"