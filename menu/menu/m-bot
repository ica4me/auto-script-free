#!/bin/bash
# ===========================================
# ü§ñ BOT MANAGEMENT PANEL - ELEGANT PURPLE BOX
# Includes Backup & Restore Tool (WEBSITE)
# By Wangsia - 2025 Edition
# ===========================================

# Config / Paths
DB_PATH="/root/BotVPN2/sellvpn.db"
BACKUP_DIR="/root/BotVPN2/backupvpn"
CFG_FILE="/root/.backupcfg"    # stores BOT_TOKEN and CHAT_ID

# ====== WARNA ======
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
WHITE='\033[1;37m'
NC='\033[0m'

# ====== UTILS ======
format_status() {
  [[ "$1" == "active" ]] && echo -e "${GREEN}ON${NC}" || echo -e "${RED}OFF${NC}"
}

# Read config (BOT_TOKEN & CHAT_ID)
load_cfg() {
  BOT_TOKEN=""
  CHAT_ID=""
  if [[ -f "$CFG_FILE" ]]; then
    # simple key=val parsing
    while IFS='=' read -r k v; do
      k=$(echo "$k" | tr -d ' ')
      v=$(echo "$v" | tr -d '\r')
      case "$k" in
        BOT_TOKEN) BOT_TOKEN="$v" ;;
        CHAT_ID) CHAT_ID="$v" ;;
      esac
    done < "$CFG_FILE"
  fi
}

save_cfg() {
  mkdir -p "$(dirname "$CFG_FILE")"
  printf "BOT_TOKEN=%s\nCHAT_ID=%s\n" "$BOT_TOKEN" "$CHAT_ID" > "$CFG_FILE"
  chmod 600 "$CFG_FILE"
}

# ====== SYSTEM STATUS ======
status_kyt=$(systemctl is-active kyt 2>/dev/null)
status_cybervpn=$(systemctl is-active botrs 2>/dev/null)
status_sellvpn=$(systemctl is-active sellvpn 2>/dev/null)
status_bot_kyt=$(format_status "$status_kyt")
status_bot_cybervpn=$(format_status "$status_cybervpn")
status_bot_sellvpn=$(format_status "$status_sellvpn")
ip_server=$(wget -qO- ipinfo.io/ip 2>/dev/null || echo "N/A")
tanggal_server=$(date +"%Y-%m-%d %H:%M:%S")

# ====== BOX DRAW HELPERS ======
print_header() { echo -e "${PURPLE}‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ${NC}"; }
print_footer() { echo -e "${PURPLE}‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ${NC}"; }
print_line()   { echo -e "${PURPLE}‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§${NC}"; }

# ====== BACKUP / TELEGRAM HELPERS ======
ensure_backup_dir() {
  mkdir -p "$BACKUP_DIR"
}

# send document via WEBSITE (returns JSON)
tg_send_document() {
  local file="$1"
  local caption="$2"
  if [[ -z "$BOT_TOKEN" || -z "$CHAT_ID" ]]; then
    echo "NO_CFG"
    return 1
  fi
  if [[ ! -f "$file" ]]; then
    echo "NO_FILE"
    return 2
  fi

  # Use curl multipart/form-data
  resp=$(curl -s -F chat_id="$CHAT_ID" -F document=@"$file" -F caption="$caption" "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument")
  echo "$resp"
  return 0
}

# extract file_id from WEBSITE response (works without jq)
extract_file_id() {
  local json="$1"
  echo "$json" | grep -Po '"file_id"\s*:\s*"\K[^"]+' | head -n1
}

# get file_path from getFile response
tg_get_file_path() {
  local file_id="$1"
  if [[ -z "$BOT_TOKEN" || -z "$file_id" ]]; then
    echo ""
    return 1
  fi
  resp=$(curl -s "https://api.telegram.org/bot${BOT_TOKEN}/getFile?file_id=${file_id}")
  echo "$resp" | grep -Po '"file_path"\s*:\s*"\K[^"]+' | head -n1
}

# ====== SETUP BACKUP (token & chat id) ======
setup_backup() {
  load_cfg  # ambil BOT_TOKEN & CHAT_ID lama

  clear
  print_header
  printf "${PURPLE}‚îÇ${NC} %-47s ${PURPLE}‚îÇ${NC}\n" "üíæ SETUP BACKUP (WEBSITE & Switch)"
  print_footer

  # selalu input BOT_TOKEN & CHAT_ID (tidak skip)
  read -rp "BOT_TOKEN: " input_token
  read -rp "CHAT_ID  : " input_chat
  BOT_TOKEN="${input_token//[[:space:]]/}"
  CHAT_ID="${input_chat//[[:space:]]/}"
  save_cfg
  echo -e "${GREEN}‚úîÔ∏è Config BOT_TOKEN & CHAT_ID disimpan${NC}"

  # setup switch ON/OFF
  CURRENT_SWITCH=$(grep -i "^switch" "$CFG_FILE" 2>/dev/null | awk -F'=' '{print $2}')
  echo -ne "Set Backup Switch [on/off] (sekarang: ${CURRENT_SWITCH:-off}): "
  read -r input_switch
  case "$input_switch" in
      on|ON) SWITCH="on" ;;
      off|OFF) SWITCH="off" ;;
      *) SWITCH="${CURRENT_SWITCH:-off}" ;;
  esac

  if grep -q "^switch" "$CFG_FILE" 2>/dev/null; then
      sed -i "s/^switch=.*/switch=$SWITCH/" "$CFG_FILE"
  else
      echo "switch=$SWITCH" >> "$CFG_FILE"
  fi

  echo -e "${GREEN}‚úî Backup switch di-set ke: $SWITCH${NC}"
  sleep 1
}



# ====== BACKUP (zip, patch, id, send telegram) ======


# ====== RESTORE (input patch + id) ======
restore_action() {
    CFG="/root/.backupcfg"
    DB_PATH="/root/BotVPN2/sellvpn.db"

    PURPLE="\e[35m"; BLUE="\e[36m"; WHITE="\e[97m"
    GREEN="\e[92m"; RED="\e[91m"; YELLOW="\e[93m"; NC="\e[0m"

    clear
    print_header
    echo -e "${PURPLE}‚ïë${WHITE}       ‚ôªÔ∏è RESTORE DATABASE ‚Äî D¬£VSX SYSTEM      ${PURPLE}‚ïë${NC}"
    print_footer
    echo

    # Load WEBSITE config
    if [[ -f "$CFG" ]]; then
        BOT_TOKEN=$(grep -i "BOT_TOKEN" "$CFG" | awk -F'=' '{print $2}' | xargs)
        CHAT_ID=$(grep -i "CHAT_ID" "$CFG" | awk -F'=' '{print $2}' | xargs)
    fi

    if [[ -z "$BOT_TOKEN" || -z "$CHAT_ID" ]]; then
        echo -e "${YELLOW}‚öôÔ∏è Masukkan konfigurasi WEBSITE:${NC}"
        read -p "BOT_TOKEN: " BOT_TOKEN
        read -p "CHAT_ID: " CHAT_ID
        cat > "$CFG" <<EOF
BOT_TOKEN=$BOT_TOKEN
CHAT_ID=$CHAT_ID
EOF
    fi
    
    #STOP BOTNYA
    systemctl stop sellvpn

    # Input File ID & Path WEBSITE
    read -p "üìÇ Masukkan File ID WEBSITE: " fileId
    read -p "üìÇ Masukkan File Path WEBSITE: " filePath
    if [[ -z "$fileId" || -z "$filePath" ]]; then
        echo -e "${RED}‚ùå File ID / Path kosong${NC}"
        return 1
    fi

    # Download langsung
    fileUrl="https://api.telegram.org/file/bot${BOT_TOKEN}/${filePath}"
    curl -s -L -o "$DB_PATH" "$fileUrl" || { echo -e "${RED}‚ùå Download gagal${NC}"; return 1; }

    # Kirim info restore
    INFO="‚ôªÔ∏è *Restore Completed*
ü™™ FILE ID: \`$fileId\`
üì¶ FILE PATH: \`$filePath\`
üìÖ Tanggal: \`$(date +"%d-%m-%Y %H:%M")\`"

    curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
        -d chat_id="$CHAT_ID" \
        -d parse_mode="Markdown" \
        -d text="$INFO" >/dev/null

    echo -e "${GREEN}‚úî Restore sellvpn.db berhasil${NC}"
    systemctl restart sellvpn 
    read -n 1 -s -r -p "Press any key to return to menu"
    menu_backup_tool
}




autoBackup() {
    CFG_FILE="/root/.backupcfg"
    CRON_FILE="/etc/cron.d/bckp_botvpn"
    SCRIPT_PATH="/usr/local/sbin/backup_action"

    PURPLE="\e[35m"
    BLUE="\e[36m"
    WHITE="\e[97m"
    GREEN="\e[92m"
    RED="\e[91m"
    NC="\e[0m"

    # Ambil status & interval
    switch=$(grep -i "switch" "$CFG_FILE" 2>/dev/null | awk '{print $2}')
    interval=$(grep -i "interval" "$CFG_FILE" 2>/dev/null | awk '{print $2}')

    clear
    print_header
    echo -e "${PURPLE}‚ïë${WHITE} ‚è∞ AUTO BACKUP CONFIGURATION ‚Äî D¬£VSX SYSTEM  ${PURPLE}‚ïë${NC}"
    print_footer

    echo -e "${BLUE}‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê${NC}"
    echo -e "${BLUE}‚îÇ${NC} Status AutoBackup : $( [[ "$switch" == "on" ]] && echo -e "${GREEN}[ON]${NC}" || echo -e "${RED}[OFF]${NC}" )"
    echo -e "${BLUE}‚îÇ${NC} Backup Interval  : ${interval:-Not Set}"
    echo -e "${BLUE}‚îÇ${NC}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    echo -e "${BLUE}‚îÇ${NC} [1] Turn ON / Set Interval"
    echo -e "${BLUE}‚îÇ${NC} [2] Turn OFF Auto Backup"
    echo -e "${BLUE}‚îÇ${NC} [3] Back To Menu"
    echo -e "${BLUE}‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò${NC}"

    echo -ne "\n${WHITE}Select Option [1-3] : ${NC}"
    read opt
    case "$opt" in
        1)
            clear
            print_header
            echo -e "${PURPLE}‚ïë${WHITE}         ‚è±  SELECT BACKUP INTERVAL            ${PURPLE}‚ïë${NC}"
            print_footer

            echo -e "${WHITE}[1]${NC} Every 1 Jam"
            echo -e "${WHITE}[2]${NC} Every 6 Jam"
            echo -e "${WHITE}[3]${NC} Every 12 Jam"
            echo -e "${WHITE}[4]${NC} Every 1 Hari"
            echo -ne "\n${WHITE}Choose Interval [1-4]: ${NC}"
            read choice
            case "$choice" in
                1) interval="1h"; cron="0 * * * *" ;;
                2) interval="6h"; cron="0 */6 * * *" ;;
                3) interval="12h"; cron="0 */12 * * *" ;;
                4) interval="1d"; cron="0 0 * * *" ;;
                *) echo -e "${RED}Invalid choice!${NC}"; sleep 1; autoBackup ;;
            esac

            # update .backupcfg
            sed -i "s/^switch.*/switch on/" "$CFG_FILE" 2>/dev/null || echo "switch on" >> "$CFG_FILE"
            if grep -q "interval" "$CFG_FILE"; then
                sed -i "s/^interval.*/interval $interval/" "$CFG_FILE"
            else
                echo "interval $interval" >> "$CFG_FILE"
            fi

            # buat cron job
            cat > "$CRON_FILE" << END
SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
$cron root bash $SCRIPT_PATH >/dev/null 2>&1
END

            chmod 644 "$CRON_FILE"
            systemctl restart cron >/dev/null 2>&1

            echo -e "\n${GREEN}[INFO] AutoBackup is ON with interval ${WHITE}$interval${NC}"
            echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
            sleep 2
            autoBackup
            ;;
        2)
            # Matikan autobackup
            sed -i "s/^switch.*/switch off/" "$CFG_FILE" 2>/dev/null || echo "switch off" >> "$CFG_FILE"
            rm -f "$CRON_FILE"
            systemctl restart cron >/dev/null 2>&1
            echo -e "\n${RED}[INFO] AutoBackup turned OFF${NC}"
            sleep 2
            autoBackup
            ;;
        3)
            clear
            m-bot
            ;;
        *)
            echo -e "${RED}Invalid option!${NC}"
            sleep 1
            autoBackup
            ;;
    esac
}

# ====== BACKUP & RESTORE MENU (inside XWAN submenu) ======
menu_backup_tool() {
  while true; do
    clear
    print_header
    printf "${PURPLE}‚îÇ${NC} %-47s ${PURPLE}‚îÇ${NC}\n" "üíæ BACKUP & RESTORE TOOL"
    print_line
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "1Ô∏è‚É£  Setup Backup (BOT_TOKEN & CHAT_ID)"
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "2Ô∏è‚É£  Backup Database (Kirim ke WEBSITE)"
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "3Ô∏è‚É£  Restore Database (Dari Patch & ID)"
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "4Ô∏è‚É£  Setup AutoBackupBot"
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "0Ô∏è‚É£  Kembali"
    print_footer
    read -rp "Pilih opsi [0-3]: " bopt
    case $bopt in
      1) setup_backup ;;
      2) backup_action ;;
      3) restore_action ;;
      4) autoBackup ;;
      0) break ;;
      *) echo -e "${RED}Pilihan tidak valid!${NC}"; sleep 1 ;;
    esac
  done
}

# ====== SUBMENU XWAN VPN (updated to include backup tool) ======
menu_xwanvpn() {
  while true; do
    clear
    print_header
    printf "${PURPLE}‚îÇ${NC} %-49s ${PURPLE}‚îÇ${NC}\n" "‚öôÔ∏è  MENU BOT XWAN VPN"
    print_line
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "1Ô∏è‚É£  Plugin Bot Seller XWAN VPN"
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "2Ô∏è‚É£  Bot Seller XWAN VPN"
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "3Ô∏è‚É£  Bot Seller XWAN Orkut Belum Upgrade"
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "4Ô∏è‚É£  Restart Bot XWAN VPN"
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "5Ô∏è‚É£  Backup & Restore Tool"
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "0Ô∏è‚É£  Kembali"
    print_footer
    read -rp "Pilih opsi [0-5]: " optx
    case $optx in
      1) clear; apt install dos2unix -y  && wget -q https://raw.githubusercontent.com/ica4me/auto-script-free/main/api.sh && chmod +x api.sh && dos2unix api.sh && ./api.sh ;;
      2) clear; sysctl -w net.ipv6.conf.all.disable_ipv6=1 >/dev/null 2>&1; sysctl -w net.ipv6.conf.default.disable_ipv6=1 >/dev/null 2>&1; apt update -y >/dev/null 2>&1; apt install -y git curl >/dev/null 2>&1; curl -L -k -sS https://raw.githubusercontent.com/myridwan/BotVPN2/refs/heads/ipuk/start -o start && bash start sellvpn && rm -f start ;;
      3) clear; sysctl -w net.ipv6.conf.all.disable_ipv6=1 >/dev/null 2>&1; sysctl -w net.ipv6.conf.default.disable_ipv6=1 >/dev/null 2>&1; apt update -y >/dev/null 2>&1; apt install -y git curl >/dev/null 2>&1; curl -L -k -sS https://raw.githubusercontent.com/myridwan/BotVPN2/refs/heads/ipuk/start2 -o start2 && bash start2 sellvpn && rm -f start2 ;;
      4) clear; print_header; printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "üîÑ Restarting Bot XWAN VPN..."; print_footer; systemctl restart sellvpn; echo -e "${GREEN}‚úÖ Restarted.${NC}"; read -n 1 -s -r -p "ENTER";;
      5) menu_backup_tool ;;
      0) break ;;
      *) echo -e "${RED}Pilihan tidak valid!${NC}"; sleep 1 ;;
    esac
  done
}
# ====== SUBMENU XWAN WILDCARD (updated to include backup tool) ======
menu_wildcard() {
  while true; do
    clear
    print_header
    printf "${PURPLE}‚îÇ${NC} %-49s ${PURPLE}‚îÇ${NC}\n" "‚öôÔ∏è  MENU BOT WILDCARD VPN"
    print_line
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "1Ô∏è‚É£  Install Bot Wildcard XWAN VPN"
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "2Ô∏è‚É£  Restart Bot Wildcard XWAN VPN"
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "0Ô∏è‚É£  Kembali"
    print_footer
    read -rp "Pilih opsi [0-5]: " optx
    case $optx in
      1) clear; wget https://raw.githubusercontent.com/ica4me/auto-script-free/main/botwc/wcbot.sh && chmod +x * && ./wcbot.sh && rm -rf wcbot.sh ;;
      2) clear; systemctl restart botcf ;;
      0) break ;;
      *) echo -e "${RED}Pilihan tidak valid!${NC}"; sleep 1 ;;
    esac
  done
}

# ====== other submenus (panel / reseller / notif) ======
menu_panel() {
  while true; do
    clear
    print_header
    printf "${PURPLE}‚îÇ${NC} %-47s ${PURPLE}‚îÇ${NC}\n" "üß© MENU BOT PANEL"
    print_line
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "1Ô∏è‚É£  Add Bot Panel"
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "2Ô∏è‚É£  Delete Bot Panel"
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "3Ô∏è‚É£  Stop Bot Panel"
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "4Ô∏è‚É£  Restart Bot Panel"
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "0Ô∏è‚É£  Kembali"
    print_footer
    read -rp "Pilih opsi [0-4]: " opt
    case $opt in
      1) clear; wget -q https://raw.githubusercontent.com/ica4me/auto-script-free/main/bot/kyt.sh && chmod +x kyt.sh && ./kyt.sh ;;
      2) clear; hapus-bot ;;
      3) clear; stop-bot ;;
      4) clear; systemctl restart sellvpn; echo -e "${GREEN}Restarted.${NC}"; read -n 1 -s -r -p "ENTER";;
      0) break ;;
      *) echo -e "${RED}Pilihan tidak valid!${NC}"; sleep 1 ;;
    esac
  done
}

menu_reseller() {
  while true; do
    clear
    print_header
    printf "${PURPLE}‚îÇ${NC} %-47s ${PURPLE}‚îÇ${NC}\n" "üí∞ MENU BOT RESELLER"
    print_line
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "1Ô∏è‚É£  Add Bot Reseller"
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "2Ô∏è‚É£  Add Bot Regis"
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "0Ô∏è‚É£  Kembali"
    print_footer
    read -rp "Pilih opsi [0-2]: " opt
    case $opt in
      1) clear; wget -q https://raw.githubusercontent.com/ica4me/auto-script-free/main/botrs.sh && chmod +x botrs.sh && ./botrs.sh ;;
      2) clear; bot2 ;;
      0) break ;;
      *) echo -e "${RED}Pilihan tidak valid!${NC}"; sleep 1 ;;
    esac
  done
}

menu_notif() {
  while true; do
  clear
  print_header
  printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "üîî MENU BOT NOTIFIKASI"
  print_line
  printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "1Ô∏è‚É£  Add Bot Notifikasi"
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "2Ô∏è‚É£  Add Bot Notifikasi Limit Quota"
    printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "0Ô∏è‚É£  Kembali"
    print_footer
    read -rp "Pilih opsi [0-2]: " opt
    case $opt in
      1) clear; add-bot-notif ;;
      2) clear; add-bot-notif-limit ;;
      0) break ;;
      *) echo -e "${RED}Pilihan tidak valid!${NC}"; sleep 1 ;;
    esac
  done
}

# ====== MAIN MENU ======
while true; do
  # refresh statuses
  status_kyt=$(systemctl is-active kyt 2>/dev/null)
  status_cybervpn=$(systemctl is-active botrs 2>/dev/null)
  status_sellvpn=$(systemctl is-active sellvpn 2>/dev/null)
  status_bot_kyt=$(format_status "$status_kyt")
  status_bot_cybervpn=$(format_status "$status_cybervpn")
  status_bot_sellvpn=$(format_status "$status_sellvpn")
  ip_server=$(wget -qO- ipinfo.io/ip 2>/dev/null || echo "N/A")
  tanggal_server=$(date +"%Y-%m-%d %H:%M:%S")

  clear
  print_header
  printf "${PURPLE}‚îÇ${NC} %-47s ${PURPLE}‚îÇ${NC}\n" "ü§ñ BOT MANAGEMENT PANEL"
  print_line
  printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "1Ô∏è‚É£  Menu Bot Panel"
  printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "2Ô∏è‚É£  Menu Bot Reseller"
  printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "3Ô∏è‚É£  Menu Bot XWAN VPN"
  printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "4Ô∏è‚É£  Menu Bot Notifikasi"
  printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "5Ô∏è‚É£  Menu Bot Wildcard"
  printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "6Ô∏è‚É£  Restart Semua Bot"
  printf "${PURPLE}‚îÇ${NC} %-50s ${PURPLE}‚îÇ${NC}\n" "0Ô∏è‚É£  Keluar"
  print_line
  printf "${PURPLE}‚îÇ${NC} %-23s : %-29s ${PURPLE}‚îÇ${NC}\n" "Bot Panel" "$status_bot_kyt"
  printf "${PURPLE}‚îÇ${NC} %-23s : %-29s ${PURPLE}‚îÇ${NC}\n" "Bot Reseller" "$status_bot_cybervpn"
  printf "${PURPLE}‚îÇ${NC} %-23s : %-29s ${PURPLE}‚îÇ${NC}\n" "Bot XWAN VPN" "$status_bot_sellvpn"
  print_line
  printf "${PURPLE}‚îÇ${NC} %-25s : %-19s ${PURPLE}‚îÇ${NC}\n" "üì° IP Server" "$ip_server"
  printf "${PURPLE}‚îÇ${NC} %-25s : %-12s ${PURPLE}‚îÇ${NC}\n" "üìÖ Tanggal" "$tanggal_server"
  print_footer

  echo ""
  read -rp "Pilih menu [0-5]: " main_opt
  case $main_opt in
    1) menu_panel ;;
    2) menu_reseller ;;
    3) menu_xwanvpn ;;
    4) menu_notif ;;
    5) menu_wildcard ;;
    6) 
       # Restart all bots: attempt to restart known services
       systemctl restart kyt 2>/dev/null
       systemctl restart botrs 2>/dev/null
       systemctl restart sellvpn 2>/dev/null
       echo -e "${GREEN}‚úÖ Semua bot di-restart (jika service tersedia).${NC}"
       read -n 1 -s -r -p "ENTER"
       ;;
    0) clear; echo -e "${GREEN}üëã Keluar dari panel...${NC}"; exit 0 ;;
    *) echo -e "${RED}‚ùå Pilihan tidak valid!${NC}"; sleep 1 ;;
  esac
done
