#!/usr/bin/env bash
set -euo pipefail

# ====== CONFIG ======
REPO_URL="https://github.com/purplemashu/me-cli"
REPO_DIR="me-cli"

# ====== THEME ======
PURPLE='\033[35m'
RED='\033[31m'
GREEN='\033[32m'
RESET='\033[0m'

line() { printf "${PURPLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}\n"; }
title() { line; echo -e "      üåå  ME-DOR  üåå"; line; }
pause() { read -rp "Tekan enter untuk lanjut..."; }
log_error() { echo -e "${RED}[!] $1${RESET}"; }
log_success() { echo -e "${GREEN}[‚úì] $1${RESET}"; }
log_info() { echo -e "[*] $1"; }

# ====== FIXED PATH FUNCTIONS ======
get_venv_python() {
    if [[ -f "$REPO_DIR/.venv/bin/python" ]]; then
        echo "$REPO_DIR/.venv/bin/python"
    else
        echo ""
    fi
}

get_venv_pip() {
    if [[ -f "$REPO_DIR/.venv/bin/pip" ]]; then
        echo "$REPO_DIR/.venv/bin/pip"
    else
        echo ""
    fi
}

ensure_prereq() {
    log_info "Cek & install dependensi..."
    
    if command -v apt >/dev/null 2>&1; then
        sudo apt update -y
        sudo apt install -y git python3 python3-pip python3-venv
    elif command -v yum >/dev/null 2>&1; then
        sudo yum install -y git python3 python3-pip
    elif command -v dnf >/dev/null 2>&1; then
        sudo dnf install -y git python3 python3-pip python3-virtualenv
    else
        log_error "Package manager tidak dikenali"
        return 1
    fi
    log_success "Dependensi terinstall"
}

pick_py() {
    if command -v python3.11 >/dev/null 2>&1; then echo "python3.11"
    elif command -v python3.10 >/dev/null 2>&1; then echo "python3.10"
    elif command -v python3.9 >/dev/null 2>&1; then echo "python3.9"
    elif command -v python3.8 >/dev/null 2>&1; then echo "python3.8"
    elif command -v python3 >/dev/null 2>&1; then echo "python3"
    else echo "python"
    fi
}

create_venv_and_install() {
    test -d "$REPO_DIR" || { log_error "Repo $REPO_DIR belum ada."; return 1; }

    if [ ! -d "$REPO_DIR/.venv" ]; then
        log_info "Membuat virtualenv..."
        PY=$(pick_py)
        
        log_info "Menggunakan Python: $PY"
        $PY --version
        
        if ! $PY -m venv "$REPO_DIR/.venv"; then
            log_error "Gagal buat venv dengan $PY"
            return 1
        fi
        log_success "Virtualenv dibuat"
    fi

    # Install requirements - INI YANG DIPERBAIKI
    log_info "Install dependencies..."
    
    # Gunakan venv python yang relatif ke REPO_DIR
    cd "$REPO_DIR" || { log_error "Gagal masuk ke $REPO_DIR"; return 1; }
    
    if [ -f "requirements.txt" ]; then
        .venv/bin/python -m pip install --upgrade pip wheel
        .venv/bin/pip install -r requirements.txt
        log_success "Dependencies installed"
    else
        log_info "requirements.txt tidak ditemukan"
    fi
    
    cd - > /dev/null  # Kembali ke directory awal
}

download_and_install() {
    ensure_prereq

    if [ -d "$REPO_DIR" ]; then
        log_info "Folder $REPO_DIR sudah ada"
    else
        log_info "Cloning repository..."
        git clone "$REPO_URL" "$REPO_DIR" || {
            log_error "Gagal clone repository"
            return 1
        }
    fi

    create_venv_and_install
    log_success "Download + install selesai"
}

run_app() {
    if [ ! -d "$REPO_DIR" ]; then
        log_error "Repo belum ada. Jalankan menu 1 dulu."
        return 1
    fi

    # INI FIX UTAMA - PASTIKAN JALAN DI FOLDER me-cli
    log_info "Menjalankan aplikasi di folder $REPO_DIR..."
    cd "$REPO_DIR" || { log_error "Gagal masuk ke $REPO_DIR"; return 1; }

    # Cek file main.py ada atau tidak
    if [ ! -f "main.py" ]; then
        log_error "File main.py tidak ditemukan di $(pwd)"
        ls -la
        cd - > /dev/null
        return 1
    fi

    # Jalankan dengan venv jika ada, else system python
    if [ -f ".venv/bin/python" ]; then
        log_info "Menjalankan dengan virtual environment..."
        .venv/bin/python main.py
    else
        log_info "Menjalankan dengan python sistem..."
        python3 main.py || python main.py
    fi
    
    local exit_code=$?
    cd - > /dev/null  # Kembali ke directory awal
    return $exit_code
}

update_all() {
    if [ ! -d "$REPO_DIR" ]; then
        log_error "Repo belum ada. Jalankan menu 1 dulu."
        return 1
    fi

    log_info "Updating repository..."
    cd "$REPO_DIR" || { log_error "Gagal masuk ke $REPO_DIR"; return 1; }

    # Update git
    if [ -d ".git" ]; then
        git fetch origin
        if git status | grep -q "behind"; then
            git pull --rebase
            log_success "Repository updated"
        else
            log_info "Already up-to-date"
        fi
    fi

    # Update pip packages
    if [ -f ".venv/bin/python" ]; then
        log_info "Updating pip packages..."
        .venv/bin/python -m pip install --upgrade pip wheel
        if [ -f "requirements.txt" ]; then
            .venv/bin/pip install -r requirements.txt --upgrade
            log_success "Packages updated"
        fi
    else
        log_error "Virtual environment tidak ditemukan"
        cd - > /dev/null
        return 1
    fi
    
    cd - > /dev/null
    log_success "Update selesai"
}

clean_env() {
    if [ -d "$REPO_DIR" ]; then
        log_info "Membersihkan venv dan cache..."
        rm -rf "$REPO_DIR/.venv" 
        find "$REPO_DIR" -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        find "$REPO_DIR" -name "*.pyc" -delete 2>/dev/null || true
        log_success "Bersih-bersih selesai"
    else
        log_info "Repo belum ada"
    fi
}

debug_system() {
    log_info "=== SYSTEM DEBUG INFO ==="
    echo "Current directory: $(pwd)"
    echo "Python versions:"
    command -v python3 && python3 --version
    echo
    echo "Repo directory contents:"
    if [ -d "$REPO_DIR" ]; then
        ls -la "$REPO_DIR/"
        echo
        echo "Main.py exists: $(if [ -f "$REPO_DIR/main.py" ]; then echo "YES"; else echo "NO"; fi)"
        echo "Venv exists: $(if [ -d "$REPO_DIR/.venv" ]; then echo "YES"; else echo "NO"; fi)"
    else
        echo "Repo folder tidak ditemukan"
    fi
    line
}

while true; do
    clear
    title
    echo
    echo "  [1] ‚¨áÔ∏è  Download + Install"
    echo "  [2] ‚ñ∂Ô∏è  Jalankan me-cli"
    echo "  [3] üîÑ Update (git + pip)"
    echo "  [4] üßπ Bersihkan venv & cache"
    echo "  [5] üêõ Debug System"
    echo "  [6] ‚ùå Keluar"
    echo
    line
    read -rp " Pilih opsi [1-6]: " choice

    case "$choice" in
        1) download_and_install ;;
        2) run_app ;;
        3) update_all ;;
        4) clean_env ;;
        5) debug_system ;;
        6) log_success "Bye!"; exit 0 ;;
        *) log_error "Pilihan tidak valid" ;;
    esac
    pause
done