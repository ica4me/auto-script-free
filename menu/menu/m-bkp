#!/bin/bash
# ==========================================
# Color
RED='\033[0;31m'
NC='\033[0m'
GRAY="\e[1;30m"
BLUE="\e[0;34m"
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELL='\033[0;33m'
WHITE='\033[1;97m'
PURPLE_BG='\033[44;1m'
grs="\033[96;1m"
redbg="\033[97;41m"
# Getting IP & Hostname
clear
MYIP=$(curl -sS ipv4.icanhazip.com)
IP=$(wget -qO- icanhazip.com)
dateToday=$(date +"%Y-%m-%d")
Name=$(curl -s https://raw.githubusercontent.com/ica4me/auto-script-free/main/romsip | grep $MYIP | awk '{print $2}')

# =======================
# Mini loading animation function
loading() {
    local msg=$1
    local i
    echo -ne "$msg "
    for i in {1..10}; do
        echo -n "."
        sleep 0.2
    done
    echo
}

# =======================
# Setup Bot
setup_bot() {
    switch=$(grep -i "switch" /root/.bckupbot | awk '{print $2}')
    clear
    echo -e "${BLUE}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e " ${PURPLE_BG}            ğŸ¤–  SETUP TELEGRAM BOT ğŸ¤–          ${NC}"
    echo -e "${BLUE}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}" 
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo "Pergi ke @BotFather dan ketik /newbot untuk membuat bot baru"
    echo "Pergi ke @MissRose_bot dan ketik /id untuk mendapatkan ID telegram"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    read -p "Bot Token : " getToken
    read -p "Admin ID  : " adminID
    echo "$getToken" >/root/.bckupbot
    echo "$adminID" >>/root/.bckupbot
    echo "switch $switch" >>/root/.bckupbot
    read -n 1 -s -r -p "Press any key to back on Bot menu"
    m_bckp
}

# =======================
# Backup Bot
botBackup() {
    clear
    bottoken=$(sed -n '1p' /root/.bckupbot | awk '{print $1}')
    adminid=$(sed -n '2p' /root/.bckupbot | awk '{print $1}')
    domain=$(cat /etc/xray/domain)
    nama2=$(cat /etc/xray/username)

    echo -e "${BLUE}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e " ${PURPLE_BG}              ğŸ’¾ VPS BACKUP TOOL ğŸ’¾            ${NC}"
    echo -e "${BLUE}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}" 

    IP=$(wget -qO- ipinfo.io/ip)
    Name=$(hostname)
    dateToday=$(date +"%Y-%m-%d")
    workDir="/root/backup"
    backupFile="/root/${IP}-${Name}-${dateToday}.zip"

    # Siapkan folder backup
    rm -rf "$workDir"
    mkdir -p "$workDir"

    # File penting
    cp /etc/passwd "$workDir"/ &>/dev/null
    cp /etc/group "$workDir"/ &>/dev/null
    cp /etc/shadow "$workDir"/ &>/dev/null
    cp /etc/gshadow "$workDir"/ &>/dev/null
    cp /etc/crontab "$workDir"/ &>/dev/null

    cp /etc/ssh/.ssh.db "$workDir"/ &>/dev/null
    cp /etc/vmess/.vmess.db "$workDir"/ &>/dev/null
    cp /etc/vless/.vless.db "$workDir"/ &>/dev/null
    cp /etc/trojan/.trojan.db "$workDir"/ &>/dev/null
    cp /etc/shadowsocks/.shadowsocks.db "$workDir"/ &>/dev/null

    # Folder penting
    cp -r /var/lib/kyt/ "$workDir/kyt2" &>/dev/null
    cp -r /etc/limit "$workDir"/ &>/dev/null
    cp -r /etc/kyt/limit "$workDir"/ &>/dev/null
    cp -r /etc/ssh "$workDir"/ &>/dev/null
    cp -r /etc/vmess "$workDir"/ &>/dev/null
    cp -r /etc/trojan "$workDir"/ &>/dev/null
    cp -r /etc/vless "$workDir"/ &>/dev/null
    cp -r /etc/shadowsocks "$workDir"/ &>/dev/null
    cp -r /etc/xray "$workDir/xray" &>/dev/null
    cp -r /var/www/html/ "$workDir/html" &>/dev/null
    cp -a /detail/ "$workDir/detail" &>/dev/null

    # Buat ZIP
    loading "[ INFO ] Creating backup"
    cd /root
    zip -r -q "${backupFile}" "backup"
    [[ -f "${backupFile}" ]] && echo -e "${GREEN}[ DONE ]${NC}" || { echo -e "${RED}[ FAILED ]${NC}"; return 1; }

    # Cek ukuran file
    filesize=$(stat -c%s "$backupFile")
    if (( filesize > 50000000 )); then
        echo -e "${RED}[ ERROR ] File terlalu besar untuk dikirim via WEBSITE (${filesize} bytes)${NC}"
        return 1
    fi

    # Kirim via WEBSITE
    loading "[ INFO ] Sending backup via WEBSITE"
    RESPONSE=$(curl -s -F "chat_id=${adminid}" -F "document=@${backupFile}" \
        "https://api.telegram.org/bot${bottoken}/sendDocument")

    if [[ $(echo "$RESPONSE" | jq -r '.ok') == "true" ]]; then
        echo -e "${GREEN}[ DONE ]${NC}"
    else
        echo -e "${RED}[ FAILED ]${NC}"
        echo "$RESPONSE"
        return 1
    fi

    fileId=$(echo "$RESPONSE" | jq -r '.result.document.file_id')
    FILE_INFO=$(curl -s "https://api.telegram.org/bot${bottoken}/getFile?file_id=${fileId}")
    filePath=$(echo "$FILE_INFO" | jq -r '.result.file_path')

    TEXT="<b>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</b>
<b>   âœ… VPS Backup Completed</b>
<b>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</b>
ğŸ“Œ <b>Date:</b> <code>${dateToday}</code>
ğŸŒ <b>IP:</b> <code>${IP}</code>
ğŸ’¥ <b>Domain:</b> <code>${domain}</code>
ğŸ‘¤ <b>Name:</b> <code>${nama2}</code>
ğŸ—‚ <b>File ID:</b> <code>${fileId}</code>
ğŸ“‚ <b>File Path:</b> <code>${filePath}</code>
<b>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</b>"

    curl -s "https://api.telegram.org/bot${bottoken}/sendMessage" \
        -d "chat_id=${adminid}" \
        --data-urlencode "text=${TEXT}" \
        -d "parse_mode=html" >/dev/null

    # Bersih-bersih
    rm -rf "$workDir" "${backupFile}"
    echo -e "${WHITE}âœ… BACKUP COMPLETED${NC}"
    read -n 1 -s -r -p "Press any key to return to menu"
    m_bckp
}

# =======================
# Restore Bot
botRestore() {
    clear
    bottoken=$(sed -n '1p' /root/.bckupbot | awk '{print $1}')
    adminid=$(sed -n '2p' /root/.bckupbot | awk '{print $1}')
    domain=$(cat /etc/xray/domain)
    nama2=$(cat /etc/xray/username)

    echo -e "${BLUE}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e " ${PURPLE_BG}              â™»ï¸ VPS RESTORE TOOL â™»ï¸            ${NC}"
    echo -e "${BLUE}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}" 
    echo ""
    read -p "ğŸ“‚ Masukkan File ID: " fileId
    read -p "ğŸ“‚ Masukkan File Path: " filePath
     

    if [[ -z "$fileId" || -z "$filePath" ]]; then
        echo -e "${RED}[ FAILED ] File ID / File Path kosong${NC}"
        return 1
    fi

    workDir="/root/restore"
    rm -rf "$workDir"
    mkdir -p "$workDir"

    backupFile="/root/backup_restore.zip"
    fileUrl="https://api.telegram.org/file/bot${bottoken}/${filePath}"

    # Download
    loading "[ INFO ] Downloading backup from WEBSITE"
    curl -s -L -o "$backupFile" "$fileUrl"
    [[ -f "$backupFile" ]] && echo -e "${GREEN}[ DONE ]${NC}" || { echo -e "${RED}[ FAILED ] Download error${NC}"; return 1; }

    # Extract
    loading "[ INFO ] Extracting backup"
    unzip -oq "$backupFile" -d "$workDir"
    [[ $? -eq 0 ]] && echo -e "${GREEN}[ DONE ]${NC}" || { echo -e "${RED}[ FAILED ] Extract error${NC}"; return 1; }

    # Restore file penting
    loading "[ INFO ] Restoring system files"
    cp -f "$workDir/backup/passwd" /etc/passwd 2>/dev/null
    cp -f "$workDir/backup/group" /etc/group 2>/dev/null
    cp -f "$workDir/backup/shadow" /etc/shadow 2>/dev/null
    cp -f "$workDir/backup/gshadow" /etc/gshadow 2>/dev/null
    cp -f "$workDir/backup/crontab" /etc/crontab 2>/dev/null

    cp -f "$workDir/backup/.ssh.db" /etc/ssh/.ssh.db 2>/dev/null
    cp -f "$workDir/backup/.vmess.db" /etc/vmess/.vmess.db 2>/dev/null
    cp -f "$workDir/backup/.vless.db" /etc/vless/.vless.db 2>/dev/null
    cp -f "$workDir/backup/.trojan.db" /etc/trojan/.trojan.db 2>/dev/null
    cp -f "$workDir/backup/.shadowsocks.db" /etc/shadowsocks/.shadowsocks.db 2>/dev/null
    
    #folder Bot notif & backup bot seller
    cp -f "$workDir/backup/limit.env" /etc/notif/limit.env 2>/dev/null
    cp -f "$workDir/backup/.backupcfg" /root/.backupcfg 2>/dev/null
    
    # Restore folder penting
    cp -r "$workDir/backup/kyt2" /var/lib/kyt/ 2>/dev/null
    cp -r "$workDir/backup/limit" /etc/ 2>/dev/null
    cp -r "$workDir/backup/limit" /etc/kyt/ 2>/dev/null
    cp -r "$workDir/backup/ssh" /etc/ 2>/dev/null
    cp -r "$workDir/backup/vmess" /etc/ 2>/dev/null
    cp -r "$workDir/backup/trojan" /etc/ 2>/dev/null
    cp -r "$workDir/backup/vless" /etc/ 2>/dev/null
    cp -r "$workDir/backup/shadowsocks" /etc/ 2>/dev/null
    cp -r "$workDir/backup/xray" /etc/ 2>/dev/null
    cp -r "$workDir/backup/html" /var/www/ 2>/dev/null
    cp -a "$workDir/backup/detail" / 2>/dev/null
    echo -e "${GREEN}[ DONE ]${NC}"

    # Permission penting
    chmod 600 /etc/shadow /etc/gshadow 2>/dev/null
    chmod 644 /etc/passwd /etc/group 2>/dev/null
    chmod 600 /etc/crontab 2>/dev/null

    # Notifikasi WEBSITE
    TEXT="<b>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</b>
<b>   â™»ï¸ VPS Restore Completed</b>
<b>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</b>
ğŸ“Œ <b>Date:</b> <code>$(date +"%Y-%m-%d")</code>
ğŸŒ <b>IP:</b> <code>$(wget -qO- ipinfo.io/ip)</code>
ğŸ’¥ <b>Domain:</b> <code>${domain}</code>
ğŸ‘¤ <b>Name:</b> <code>${nama2}</code>
ğŸ—‚ <b>File ID:</b> <code>${fileId}</code>
ğŸ“‚ <b>File Path:</b> <code>${filePath}</code>
<b>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</b>"

    curl -s "https://api.telegram.org/bot${bottoken}/sendMessage" \
        -d "chat_id=${adminid}" \
        --data-urlencode "text=${TEXT}" \
        -d "parse_mode=html" >/dev/null

    # Bersih-bersih
    rm -rf "$workDir" "$backupFile"
    echo -e "${WHITE}âœ… RESTORE COMPLETED â€” Reboot VPS sekarang${NC}"
    read -n 1 -s -r -p "Press any key to return to menu"
    m_bckp
}
autoBackup() {
    # Ambil status & interval
    switch=$(grep -i "switch" /root/.bckupbot | awk '{print $2}')
    interval=$(grep -i "interval" /root/.bckupbot | awk '{print $2}')

    clear
    echo -e "${BLUE}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e " ${PURPLE_BG}         â° AUTO BACKUP CONFIGURATION         ${NC}"
    echo -e "${BLUE}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}\n"

    echo -e "${BLUE}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e "${BLUE}â”‚${NC} Status AutoBackup : $( [[ "$switch" == "on" ]] && echo -e "${GREEN}[ON]${NC}" || echo -e "${RED}[OFF]${NC}" )"
    echo -e "${BLUE}â”‚${NC} Backup Interval  : ${interval:-Not Set}"
    echo -e "${BLUE}â”‚${NC} [1] Turn ON / Set Interval"
    echo -e "${BLUE}â”‚${NC} [2] Turn OFF Auto Backup"
    echo -e "${BLUE}â”‚${NC} [3] Back To Menu"
    echo -e "${BLUE}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"

    echo -ne "\nSelect Option [1-3] : "
    read opt
    case "$opt" in
        1)
            clear
            echo -e "${PURPLE_BG}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
            echo -e "${PURPLE_BG}â”‚      â±  Select Interval       â”‚${NC}"
            echo -e "${PURPLE_BG}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}\n"

            echo "1) Every 1 Jam"
            echo "2) Every 6 Jam"
            echo "3) Every 12 Jam"
            echo "4) Every 1 Hari"
            echo -ne "\nChoose Interval [1-4]: "
            read choice
            case "$choice" in
                1) interval="1h"; cron="0 * * * *" ;;
                2) interval="6h"; cron="0 */6 * * *" ;;
                3) interval="12h"; cron="0 */12 * * *" ;;
                4) interval="1d"; cron="0 0 * * *" ;;
                *) echo "Invalid choice!"; sleep 1; autoBackup ;;
            esac

            # update .bckupbot
            sed -i "s/^switch.*/switch on/" /root/.bckupbot 2>/dev/null || echo "switch on" >> /root/.bckupbot
            if grep -q "interval" /root/.bckupbot; then
                sed -i "s/^interval.*/interval $interval/" /root/.bckupbot
            else
                echo "interval $interval" >> /root/.bckupbot
            fi

            # buat cron.d file
            cat > /etc/cron.d/bckp_otm << END
SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
$cron root bash /usr/local/sbin/backup
END

            chmod 644 /etc/cron.d/bckp_otm
            systemctl restart cron >/dev/null 2>&1
            echo -e "${GREEN}[INFO] AutoBackup is ON with interval $interval${NC}"
            sleep 2
            autoBackup
            ;;
        2)
            sed -i "s/^switch.*/switch off/" /root/.bckupbot
            rm -f /etc/cron.d/bckp_otm
            systemctl restart cron >/dev/null 2>&1
            echo -e "${RED}[INFO] AutoBackup Turned OFF${NC}"
            sleep 2
            autoBackup
            ;;
        3)
            m_bckp
            ;;
        *)
            autoBackup
            ;;
    esac
}

# =======================
# Menu Utama
m_bckp() {
    switch=$(grep -i "switch" /root/.bckupbot | awk '{print $2}')
    clear
    if [ "${switch}" == "on" ]; then
        sts="\033[30;42m [ON] \033[0m"
    else
        sts="\033[30;41m [OFF] \033[0m"
    fi

    echo -e "${BLUE}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e " ${PURPLE_BG}        ğŸ¤– TELEGRAM BOT (AutoBackup) ğŸ¤–        ${NC}"
    echo -e "${BLUE}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}" 

    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}" 
    echo -e "Status AutoBackup : ${sts}"
    echo -e "${redbg}[1]${NC} Setup Bot WEBSITE"
    echo -e "${redbg}[2]${NC} Setup Auto Backup Status"
    echo -e "${redbg}[3]${NC} Backup VPS (WEBSITE Bot)"
    echo -e "${redbg}[4]${NC} Restore Data"
    echo -e "${redbg}[5]${NC} Restore Sc Potato"
    echo -e "${redbg}[6]${NC} Back To Main Menu"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}" 

    echo -ne "\nSelect From Options [ 1 - 5 ] : "
    read botch
    case "$botch" in
    1) setup_bot ;;
    2) autoBackup ;;
    3) backup ;;
    4) botRestore ;;
    5) restorepot ;;
    6) menu ;;
    *) m_bckp ;;
    esac
}

# =======================
# Start
clear
[[ ! -f /root/.bckupbot ]] && {
    echo "Please Input Bot Details First"
    sleep 2
    clear
    read -p "Bot Token : " getToken
    read -p "Admin ID  : " adminID
    echo "$getToken" >/root/.bckupbot
    echo "$adminID" >>/root/.bckupbot
    echo "switch off" >>/root/.bckupbot
}
m_bckp
