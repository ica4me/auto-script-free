#!/bin/bash
# =========================================
# Script Renew NoobzVPN | Fixed Sync System
# =========================================
clear
# Warna
red() { echo -e "\\033[32;1m${*}\\033[0m"; }
BlueCyan='\e[5;36m'
NC='\e[0m'

# Validasi Izin
checking_sc() {
    if [[ ! -f "/usr/bin/user" ]]; then echo "admin" > /usr/bin/user; echo "2099-12-31" > /usr/bin/e; fi
}
checking_sc

# Variabel
nama=$(cat /etc/xray/username 2>/dev/null)

# Fungsi Banner
function baris_panjang() { echo -e "\033[5;36m ◇━━━━━━━━━━━━━━━━━◇ \033[0m"; }
function Xwan_Banner() {
    clear
    baris_panjang
    echo -e "\033[95;1m     $nama       \033[0m"
    baris_panjang
}

function Sc_Credit(){
    sleep 1
    baris_panjang
    echo -e "\033[2;35m      User Berhasil Diperpanjang \033[0m"
    echo -e "\033[2;35m           $nama  \033[0m"
    baris_panjang
    exit 0
}

Xwan_Banner
echo -e "     RENEW USER NOOBZVPN"
baris_panjang
# Menampilkan list user
if command -v noobzvpns &> /dev/null; then
    noobzvpns --info-all-user
else
    echo " NoobzVPN Manager belum terinstall!"
fi
baris_panjang
echo ""
read -p " Masukan Username : " user
read -p " Tambah Masa Aktif (Hari) : " masaaktif
echo ""

# Validasi User
if ! id "$user" &>/dev/null; then
    echo -e "\033[91mError: User $user tidak ditemukan di sistem!\033[0m"
    exit 1
fi

# Hitung Expired Baru (Untuk System & Database)
# Ambil expired saat ini dari system chage
exp_date_raw=$(chage -l "$user" | grep "Account expires" | cut -d: -f2 | sed 's/^ //g')
now=$(date +%Y-%m-%d)

if [[ -z "$exp_date_raw" || "$exp_date_raw" == "never" ]]; then
    d1=$(date -d "$now" +%s)
else
    d1=$(date -d "$exp_date_raw" +%s)
fi
d2=$(date -d "$now" +%s)

# Jika sudah expired, mulai hitung dari hari ini
if [[ $d1 -lt $d2 ]]; then d1=$d2; fi

# Hitung tanggal baru
exp_seconds=$(($d1 + ($masaaktif * 86400)))
new_exp_date=$(date -d "@$exp_seconds" +"%Y-%m-%d")

# --- PROSES RENEW (SYNC) ---

# 1. Update Expired di NoobzVPN
if command -v noobzvpns &> /dev/null; then
    # NoobzVPN biasanya menggunakan parameter renew/expired user
    noobzvpns --expired-user "$user" "$masaaktif"
fi

# 2. Update Expired di System Linux (Penting agar SSH tidak terkunci)
usermod -e "$new_exp_date" "$user"

# 3. Update Database SSH (Untuk catatan script)
if grep -q "^#ssh# $user" /etc/ssh/.ssh.db; then
    sed -i "s/\(^#ssh# $user .* \)[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}$/\1$new_exp_date/" /etc/ssh/.ssh.db
fi

# Tampilan Sukses
clear
baris_panjang
echo -e " NOOBZVPN RENEW SUCCESS"
baris_panjang
echo -e " Client    : $user"
echo -e " Expired   : $new_exp_date"
echo -e " Add Days  : $masaaktif Days"
Sc_Credit