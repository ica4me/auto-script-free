#!/bin/bash
# =========================================
# License Manager | Register IP VPS
# =========================================
clear
# Warna Standard
red() { echo -e "\\033[32;1m${*}\\033[0m"; }
BlueCyan='\e[5;36m'
NC='\e[0m'
ungu='\033[0;35m'
y='\033[1;93m'
g="\e[92;1m"
yell='\e[33m'

# =========================================
# 1. KONFIGURASI GITHUB ANDA (WAJIB DIISI)
# =========================================
# Ganti dengan Token GitHub Anda (Settings -> Developer Settings -> Personal access tokens)
TOKEN="ghp_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"

# Ganti dengan Username GitHub Anda
USER="username_github_anda"

# Ganti dengan Email GitHub Anda
EMAIL="email_github_anda@gmail.com"

# Ganti dengan Nama Repo Anda (Pastikan repo ini ada di akun Anda)
REPO_NAME="izinvps"

# Nama File Database IP di dalam Repo
FILE_IP="ipx"

# URL Raw File IP (Otomatis terbentuk dari variabel di atas)
REPO="https://raw.githubusercontent.com/${USER}/${REPO_NAME}/main/${FILE_IP}"

# =========================================
# 2. Validasi Izin Lokal (Admin Mode)
# =========================================
# Kita gunakan validasi lokal agar Admin selalu bisa akses menu ini
checking_sc() {
    if [[ ! -f "/usr/bin/user" ]] || [[ ! -f "/usr/bin/e" ]]; then
        echo "admin" > /usr/bin/user
        echo "2099-12-31" > /usr/bin/e
    fi
}
checking_sc

# =========================================
# 3. Variabel System
# =========================================
[[ ! -f /usr/bin/git ]] && apt install git -y &> /dev/null
MYIP=$(curl -sS ipv4.icanhazip.com)
nama=$(cat /etc/xray/username 2>/dev/null)
if [[ -z "$nama" ]]; then nama="Admin"; fi

# Telegram (Opsional)
CHATID=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 3 2>/dev/null)
KEY=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 2 2>/dev/null)
export TIME="10"
export URL="https://api.telegram.org/bot$KEY/sendMessage"

# =========================================
# 4. Fungsi Helper
# =========================================
function lane() {
    echo -e "${BlueCyan} ————————————————————————————————————————${NC}"
}

function LOGO() {
    echo -e ""
    lane
    echo -e "${ungu}            LICENSE MANAGER            "
    echo -e "${ungu}            By $nama                   "
    lane
    echo -e ""
}

function Credit_xwstore() {
    sleep 1
    echo -e "" 
    lane
    echo -e "${ungu}      Database Updated Successfully"
    echo -e "         Script Credit by $nama"
    lane
    echo -e ""
    exit 0
}

# =========================================
# 5. Fungsi Utama
# =========================================

add-ip() {
    today=`date -d "0 days" +"%Y-%m-%d"`
    clear
    LOGO
    echo -e "  [ ADD NEW IP VPS ]"
    echo ""
    
    # Setup Git Workspace
    rm -rf /root/izinvps
    mkdir -p /root/izinvps
    cd /root/izinvps
    
    echo -e "Downloading Database..."
    wget -q -O "${FILE_IP}" "${REPO}"
    if [ ! -f "${FILE_IP}" ]; then
        echo "File Database (${FILE_IP}) tidak ditemukan di Repo!"
        touch "${FILE_IP}" # Buat file baru jika tidak ada
    fi

    echo ""
    read -p " Input IP Address : " ipqu
    
    # Cek apakah IP sudah ada
    CLIENT_EXISTS=$(grep -w "$ipqu" "${FILE_IP}" | wc -l)
    if [[ ${CLIENT_EXISTS} == '1' ]]; then
        echo -e "${red}IP Already Exist !${NC}"
        read -n 1 -s -r -p "Press any key to back"
        add-ip-bot
        return
    fi

    echo -e ""
    read -p " Input Client Name : " name
    echo -e ""
    read -p " Input Expired Days : " exp
    exp2=`date -d "${exp} days" +"%Y-%m-%d"`

    # Tambahkan ke Database Lokal
    echo "### ${name} ${exp2} ${ipqu}" >> "${FILE_IP}"

    # Push ke GitHub
    echo -e "Updating Database to GitHub..."
    git config --global user.email "${EMAIL}"
    git config --global user.name "${USER}"
    git init &> /dev/null
    git add . &> /dev/null
    git commit -m "Add IP $name" &> /dev/null
    # Ganti 'main' jika branch anda beda
    git branch -M main &> /dev/null 
    git remote add origin "https://github.com/${USER}/${REPO_NAME}.git"
    git push -f "https://${TOKEN}@github.com/${USER}/${REPO_NAME}.git" &> /dev/null

    # Bersihkan
    cd /root
    rm -rf /root/izinvps

    # Notif Telegram
    TEXT="
    <code>───────────────────────────</code>
    <code>   SUCCESS REGISTERED IP</code>
    <code>───────────────────────────</code>
    <code>CLIENT         : $name</code>
    <code>IP Address     : $ipqu</code>
    <code>Registered On  : $today</code>
    <code>Expired On     : $exp2</code>
    <code>───────────────────────────</code>
    "
    curl -s --max-time $TIME -d "chat_id=$CHATID&disable_web_page_preview=1&text=$TEXT&parse_mode=html" $URL >/dev/null

    clear
    lane
    echo -e "${g}        SUCCESS ADD IP VPS      $NC"
    lane
    echo -e "${y}  USERNAME    :${NC}${yell} $name ${NC}"
    echo -e "${y}  IP ADDRESS  :${NC}${yell} $ipqu ${NC}"
    echo -e "${y}  EXPIRED ON  :${NC}${yell} $exp2 ${NC}"
    lane
    Credit_xwstore
}

del-ip() {
    clear
    LOGO
    echo -e "  [ DELETE IP VPS ]"
    echo ""
    
    rm -rf /root/izinvps
    mkdir -p /root/izinvps
    cd /root/izinvps
    wget -q -O "${FILE_IP}" "${REPO}"

    echo -e "${g}        LIST IP VPS          $NC"
    lane
    grep -E "^###" "${FILE_IP}" | cut -d ' ' -f 2-6 | column -t | sort | uniq
    lane
    echo ""
    read -p " Input IP Address To Delete : " ipdel
    
    if [[ -z "$ipdel" ]]; then
        echo "IP cannot be empty"
        add-ip-bot
        return
    fi

    name=$(cat "${FILE_IP}" | grep "$ipdel" | cut -d " " -f2)
    exp=$(cat "${FILE_IP}" | grep "$ipdel" | cut -d " " -f3)
    
    # Hapus dari file
    sed -i "/^### $name $exp $ipdel/d" "${FILE_IP}"

    # Push ke GitHub
    echo -e "Syncing with GitHub..."
    git config --global user.email "${EMAIL}"
    git config --global user.name "${USER}"
    git init &> /dev/null
    git add . &> /dev/null
    git commit -m "Delete IP $name" &> /dev/null
    git branch -M main &> /dev/null
    git remote add origin "https://github.com/${USER}/${REPO_NAME}.git"
    git push -f "https://${TOKEN}@github.com/${USER}/${REPO_NAME}.git" &> /dev/null

    cd /root
    rm -rf /root/izinvps
    
    clear
    lane
    echo -e "${g}      DONE DELETE IP VPS      $NC"
    lane
    echo -e "${y} USERNAME   :${NC}${yell} $name"
    echo -e "${y} IP ADDRESS :${NC}${yell} $ipdel"
    lane
    Credit_xwstore
}

renew-ip() {
    clear
    LOGO
    echo -e "  [ RENEW IP VPS ]"
    echo ""
    
    rm -rf /root/izinvps
    mkdir -p /root/izinvps
    cd /root/izinvps
    wget -q -O "${FILE_IP}" "${REPO}"

    lane
    grep -E "^###" "${FILE_IP}" | cut -d ' ' -f 2-6 | column -t | sort | uniq
    lane
    echo ""
    read -p "  Input IP Address To Renew : " ipdel
    read -p "  Input Extra Days          : " days
    
    name=$(cat "${FILE_IP}" | grep "$ipdel" | cut -d " " -f2)
    exp=$(cat "${FILE_IP}" | grep "$ipdel" | cut -d " " -f3)
    
    now=$(date +%Y-%m-%d)
    d1=$(date -d "$exp" +%s)
    d2=$(date -d "$now" +%s)
    exp2=$(( (d1 - d2) / 86400 ))
    exp3=$(($exp2 + $days))
    exp4=`date -d "$exp3 days" +"%Y-%m-%d"`
    
    # Update File
    sed -i "s/### $name $exp $ipdel/### $name $exp4 $ipdel/g" "${FILE_IP}"

    # Push ke GitHub
    echo -e "Syncing with GitHub..."
    git config --global user.email "${EMAIL}"
    git config --global user.name "${USER}"
    git init &> /dev/null
    git add . &> /dev/null
    git commit -m "Renew IP $name" &> /dev/null
    git branch -M main &> /dev/null
    git remote add origin "https://github.com/${USER}/${REPO_NAME}.git"
    git push -f "https://${TOKEN}@github.com/${USER}/${REPO_NAME}.git" &> /dev/null

    cd /root
    rm -rf /root/izinvps
    
    clear
    lane
    echo -e "${g}        DONE RENEW IP VPS      $NC"
    lane
    echo -e "${y}  USERNAME    :${NC}${yell} $name"
    echo -e "${y}  IP ADDRESS  :${NC}${yell} $ipdel"
    echo -e "${y}  NEW EXPIRED :${NC}${yell} $exp4"
    lane
    Credit_xwstore
}

# --- Menu Utama ---
clear
LOGO
echo -e " [1] Add IP VPS"
echo -e " [2] Delete IP VPS"
echo -e " [3] Renew IP VPS"
echo -e " [x] Exit"
echo ""
read -p " Select From Options [1-3 or x] :  " prot
echo -e ""
case $prot in
1) add-ip ;;
2) del-ip ;;
3) renew-ip ;;
x) menu ;;
*) echo "Please enter an correct number"; sleep 1; add-ip-bot ;;
esac