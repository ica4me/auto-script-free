#!/bin/bash
# ---------------------------------------------------------
# ADD BOT NOTIFIKASI — UI Keren + Animasi
# ---------------------------------------------------------

set -euo pipefail

# ============ Warna & Simbol ============
ESC="\033"
RESET="${ESC}[0m"
BOLD="${ESC}[1m"

FG_CYAN="${ESC}[36m"
FG_GREEN="${ESC}[32m"
FG_RED="${ESC}[31m"
FG_YELLOW="${ESC}[33m"
FG_GRAY="${ESC}[90m"
BG_RED="${ESC}[41m"
FG_WHITE="${ESC}[97m"

CHECK="✔"
CROSS="✖"
INFO="ℹ"
STAR="★"
ARROW="➜"
GEAR="⚙"
SPARK="✦"
DOT="●"

# ============ Utilitas Tampilan ============
hide_cursor(){ printf "${ESC}[?25l"; }
show_cursor(){ printf "${ESC}[?25h"; }
hr(){ printf "${FG_CYAN}%s${RESET}\n" "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"; }

banner(){
  clear
  hr
  printf " ${BOLD}${FG_WHITE}${BG_RED}          ADD BOT NOTIFIKASI          ${RESET}\n"
  hr
  printf "${FG_GREEN}${STAR} Tutorial Create Bot & ID WEBSITE${RESET}\n"
  printf " ${DOT} Create Bot & Token: ${BOLD}@BotFather${RESET}\n"
  printf " ${DOT} Info ID WEBSITE : ${BOLD}@MissRose_bot${RESET} (perintah ${BOLD}/info${RESET})\n"
  hr
}

# ============ Spinner & Progress ============
SPINNER_PID=""
start_spinner(){
  local msg="$1"
  local frames=('⠋' '⠙' '⠹' '⠸' '⠼' '⠴' '⠦' '⠧' '⠇' '⠏')
  hide_cursor
  (
    i=0
    while :; do
      printf "\r ${GEAR}  %s  ${FG_GRAY}%s${RESET}" "$msg" "${frames[i]}"
      i=$(( (i+1) % ${#frames[@]} ))
      sleep 0.08
    done
  ) &
  SPINNER_PID=$!
  disown
}

stop_spinner(){
  if [[ -n "${SPINNER_PID}" ]] && kill -0 "${SPINNER_PID}" 2>/dev/null; then
    kill "${SPINNER_PID}" 2>/dev/null || true
    wait "${SPINNER_PID}" 2>/dev/null || true
  fi
  printf "\r\033[K" # bersihkan baris
  show_cursor
}

progress_bar(){ # progress_bar 0.6 "Menulis data…"
  local duration="${1:-0.6}"
  local msg="${2:-"Processing…"}"
  local steps=24
  local step_time
  step_time=$(awk "BEGIN{print ${duration}/${steps}}")
  for ((i=1;i<=steps;i++)); do
    local done=$i
    local left=$((steps - i))
    printf "\r ${ARROW}  %-18s [${FG_GREEN}%0.s#${RESET}" "$msg" $(seq 1 $done)
    printf "%0.s-" $(seq 1 $left)
    printf "]"
    sleep "${step_time}"
  done
  printf "\n"
}

# ============ Validasi ============
require_nonempty(){
  local val="$1"; local label="$2"
  if [[ -z "${val}" ]]; then
    printf " ${CROSS} ${FG_RED}%s tidak boleh kosong.${RESET}\n" "$label"
    exit 1
  fi
}

require_numeric(){
  local val="$1"; local label="$2"
  if ! [[ "$val" =~ ^-?[0-9]+$ ]]; then
    printf " ${CROSS} ${FG_RED}%s harus berupa angka.${RESET}\n" "$label"
    exit 1
  fi
}

# ============ Mulai ============
trap 'show_cursor' EXIT
banner

read -rp "[*] Input your Bot Token : " -e bottoken
read -rp "[*] Input Your Id WEBSITE : " -e admin
hr

require_nonempty "$bottoken" "Bot Token"
require_nonempty "$admin" "ID WEBSITE"
require_numeric  "$admin" "ID WEBSITE"

# Siapkan direktori & database
DB_DIR="/etc/bot"
DB_FILE="${DB_DIR}/.bot.db"
mkdir -p "$DB_DIR"
touch "$DB_FILE"

# Proses penyimpanan dengan animasi
start_spinner "Memeriksa token di database…"
sleep 0.3
stop_spinner

# Hapus entri lama untuk token tersebut (jika ada)
sed -i "/^#bot#\s\+${bottoken}\b.*/d" "$DB_FILE" || true

start_spinner "Menambahkan bot ke database…"
echo "#bot# ${bottoken} ${admin}" >> "$DB_FILE"
sleep 0.15
stop_spinner

progress_bar 0.7 "Menulis data…"
sleep 0.05

# ============ Hasil ============
hr
printf " ${BOLD}${FG_WHITE}${BG_RED}      SUCCESS ADD BOT NOTIFIKASI      ${RESET}\n"
hr
printf " ${CHECK} Bot Token   : ${FG_GREEN}%s${RESET}\n" "$bottoken"
printf " ${CHECK} ID WEBSITE : ${FG_GREEN}%s${RESET}\n" "$admin"
printf " ${INFO} File DB     : ${FG_GRAY}%s${RESET}\n" "$DB_FILE"
hr

printf " ${SPARK} Selesai! Tekan [Enter] untuk kembali ke menu…"
read -r
menu
