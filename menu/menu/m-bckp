#!/bin/bash
# ==========================================
# Color
RED='\033[0;31m'
NC='\033[0m'
GRAY="\e[1;30m"
BLUE="\e[0;34m"
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELL='\033[0;33m'
WHITE='\033[1;97m'
PURPLE_BG='\033[45;1m'

# Getting IP & Hostname
clear
MYIP=$(curl -sS ipv4.icanhazip.com)
IP=$(wget -qO- icanhazip.com)
dateToday=$(date +"%Y-%m-%d")
Name=$(curl -s https://raw.githubusercontent.com/ica4me/auto-script-free/main/romsip | grep $MYIP | awk '{print $2}')
#Name=$(curl -s https://raw.githubusercontent.com/p3yx/newsc/main/ipx | grep $MYIP | awk '{print $2}')

# =======================
# Mini loading animation function
loading() {
    local msg=$1
    local i
    echo -ne "$msg "
    for i in {1..10}; do
        echo -n "."
        sleep 0.2
    done
    echo
}

# =======================
# Setup Bot
setup_bot() {
    switch=$(grep -i "switch" /root/.bckupbot | awk '{print $2}')
    clear
    echo -e "${PURPLE_BG}$(echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" | lolcat -a -d 5)${NC}"
    echo -e "${PURPLE_BG}$(echo "â”‚     ğŸ¤–  SETUP TELEGRAM BOT   â”‚" | lolcat -a -d 5)${NC}"
    echo -e "${PURPLE_BG}$(echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" | lolcat -a -d 5)${NC}\n"

    echo "Pergi ke @BotFather dan ketik /newbot untuk membuat bot baru"
    echo "Pergi ke @MissRose_bot dan ketik /id untuk mendapatkan ID telegram"
    echo ""
    read -p "Bot Token : " getToken
    read -p "Admin ID  : " adminID
    echo "$getToken" >/root/.bckupbot
    echo "$adminID" >>/root/.bckupbot
    echo "switch $switch" >>/root/.bckupbot
    read -n 1 -s -r -p "Press any key to back on Bot menu"
    m_bckp
}

# =======================
# Backup Bot
botBackup() {
    clear
    read bottoken adminid switch < /root/.bckupbot

    # Header
    echo -e "${PURPLE_BG}$(echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" | lolcat -a -d 5)${NC}"
    echo -e "${PURPLE_BG}$(echo "â”‚       ğŸ’¾ VPS BACKUP TOOL ğŸ’¾  â”‚" | lolcat -a -d 5)${NC}"
    echo -e "${PURPLE_BG}$(echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" | lolcat -a -d 5)\n"

    # Info VPS
    IP=$(wget -qO- ipinfo.io/ip)
    Name=$(hostname)
    dateToday=$(date +"%Y-%m-%d")
    backupFile="/root/${IP}-${Name}-${dateToday}.zip"

    # Creating backup
    loading "[ INFO ] Creating backup"
    for dir in /etc/xray /etc/vmess /etc/vless /etc/trojan /etc/slowdns /etc/limit /etc/bot /var/lib/kyt /root/BotVPN2; do
        [[ -d "$dir" ]] && zip -r -q "${backupFile}" "$dir"
    done
    [[ -f "${backupFile}" ]] && echo -e "${GREEN}[ DONE ]${NC}" || { echo -e "${RED}[ FAILED ]${NC}"; return 1; }

    # Check file size
    filesize=$(stat -c%s "$backupFile")
    if (( filesize > 50000000 )); then
        echo -e "${RED}[ ERROR ] File terlalu besar untuk dikirim via WEBSITE (${filesize} bytes)${NC}"
        return 1
    fi

    # Send via WEBSITE
    loading "[ INFO ] Sending backup via WEBSITE"
    RESPONSE=$(curl -s -F "chat_id=${adminid}" -F "document=@${backupFile}" \
        "https://api.telegram.org/bot${bottoken}/sendDocument")
    [[ $(echo "$RESPONSE" | jq -r '.ok') == "true" ]] && echo -e "${GREEN}[ DONE ]${NC}" || { echo -e "${RED}[ FAILED ]${NC}"; echo "$RESPONSE"; return 1; }

    fileId=$(echo "$RESPONSE" | jq -r '.result.document.file_id')
    FILE_INFO=$(curl -s "https://api.telegram.org/bot${bottoken}/getFile?file_id=${fileId}")
    filePath=$(echo "$FILE_INFO" | jq -r '.result.file_path')

    TEXT="<b>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</b>
<b>   âœ… VPS Backup Completed</b>
<b>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</b>
ğŸ“Œ <b>Date:</b> <code>${dateToday}</code>
ğŸŒ <b>IP:</b> <code>${IP}</code>
ğŸ‘¤ <b>Name:</b> <code>${Name}</code>
ğŸ—‚ <b>File ID:</b> <code>${fileId}</code>
ğŸ“‚ <b>File Path:</b> <code>${filePath}</code>
<b>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</b>"

    curl -s "https://api.telegram.org/bot${bottoken}/sendMessage" \
        -d "chat_id=${adminid}" \
        --data-urlencode "text=${TEXT}" \
        -d "parse_mode=html" >/dev/null

    rm -f "${backupFile}"
    echo -e "${WHITE}âœ… BACKUP COMPLETED${NC}"
    read -n 1 -s -r -p "Press any key to return to menu"
    m_bckp
}

# =======================
# Restore Bot
restoreBot() {
    read bottoken adminid switch < /root/.bckupbot
    clear
    echo -e "${PURPLE_BG}$(echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" | lolcat -a -d 5)${NC}"
    echo -e "${PURPLE_BG}$(echo "â”‚       ğŸ”„ VPS RESTORE TOOL ğŸ”„ â”‚" | lolcat -a -d 5)${NC}"
    echo -e "${PURPLE_BG}$(echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" | lolcat -a -d 5)\n"

    read -p "ğŸ“Œ File ID   : " fileId
    read -p "ğŸ“‚ File PATH : " filePath

    loading "[ INFO ] Downloading backup"
    curl -s -o /root/backup.zip "https://api.telegram.org/file/bot${bottoken}/${filePath}"
    [[ -f "/root/backup.zip" ]] && echo -e "${GREEN}[ DONE ]${NC}" || { echo -e "${RED}[ FAILED ]${NC}"; return 1; }

    loading "[ INFO ] Extracting backup"
    unzip -o /root/backup.zip -d / >/dev/null 2>&1
    rm -f /root/backup.zip
    echo -e "${GREEN}[ INFO ] Extraction completed${NC}"

    loading "[ INFO ] Restoring configs & system files"
    cp /etc/passwd /etc/passwd.bak 2>/dev/null
    cp /etc/group /etc/group.bak 2>/dev/null
    cp /etc/shadow /etc/shadow.bak 2>/dev/null
    cp /etc/gshadow /etc/gshadow.bak 2>/dev/null
    cp /etc/crontab /etc/crontab.bak 2>/dev/null

    [[ -f /etc/bot/.bot.db ]] && cp /etc/bot/.bot.db /etc/bot/
    [[ -f /etc/ssh/.ssh.db ]] && cp /etc/ssh/.ssh.db /etc/ssh/
    [[ -f /etc/vmess/.vmess.db ]] && cp /etc/vmess/.vmess.db /etc/vmess/
    [[ -f /etc/vless/.vless.db ]] && cp /etc/vless/.vless.db /etc/vless/
    [[ -f /etc/trojan/.trojan.db ]] && cp /etc/trojan/.trojan.db /etc/trojan/
    [[ -f /root/BotVPN2/sellvpn.db ]] && cp /root/BotVPN2/sellvpn.db /root/BotVPN2/
    echo -e "${GREEN}[ INFO ] Restore completed${NC}"

    echo -e "${WHITE}âœ… RESTORE SUCCESSFUL${NC}"
    read -n 1 -s -r -p "Press any key to return to menu"
    m_bckp
}

# =======================
# Menu Utama
m_bckp() {
    switch=$(grep -i "switch" /root/.bckupbot | awk '{print $2}')
    clear
    if [ "${switch}" == "on" ]; then
        sts="\033[30;42m [ON] \033[0m"
    else
        sts="\033[30;41m [OFF] \033[0m"
    fi

    echo -e "${PURPLE_BG}$(echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" | lolcat -a -d 5)${NC}"
    echo -e "${PURPLE_BG}$(echo "â”‚   ğŸ¤– TELEGRAM BOT (AutoBackup) â”‚" | lolcat -a -d 5)${NC}"
    echo -e "${PURPLE_BG}$(echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" | lolcat -a -d 5)\n"

    echo -e "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" | lolcat -a -d 5
    echo -e "Status AutoBackup : ${sts}"
    echo -e "[1] Setup Bot WEBSITE"
    echo -e "[2] Toggle Auto Backup Status"
    echo -e "[3] Backup VPS (WEBSITE Bot)"
    echo -e "[4] Restore Data"
    echo -e "[5] Back To Main Menu"
    echo -e "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" | lolcat -a -d 5

    echo -ne "\nSelect From Options [ 1 - 5 ] : "
    read botch
    case "$botch" in
    1) setup_bot ;;
    2) autoBackup ;;
    3) botBackup ;;
    4) restoreBot ;;
    5) menu ;;
    *) m_bckp ;;
    esac
}

# =======================
# Start
clear
[[ ! -f /root/.bckupbot ]] && {
    echo "Please Input Bot Details First"
    sleep 2
    clear
    read -p "Bot Token : " getToken
    read -p "Admin ID  : " adminID
    echo "$getToken" >/root/.bckupbot
    echo "$adminID" >>/root/.bckupbot
    echo "switch off" >>/root/.bckupbot
}
m_bckp
