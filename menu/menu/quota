#!/bin/bash

function send-log(){
  # ========== CONFIG ==========
  local ENV_FILE="/etc/notif/limit.env"
  local BOT_TOKEN CHAT_ID ADMINX

  if [ -f "$ENV_FILE" ]; then
    . "$ENV_FILE"
  fi

  local KEY="${BOT_TOKEN:-}"
  local CHATID="${CHAT_ID:-}"
  local ADMIN="${ADMINX:-}"
  local TIME="10"
  local URL="https://api.telegram.org/bot${KEY}/sendMessage"

  if [ -z "$KEY" ] || [ -z "$CHATID" ] || [ -z "$ADMIN" ]; then
    echo "[send-log] BOT_TOKEN/CHAT_ID/ADMINX tidak ditemukan di $ENV_FILE" >&2
    return 1
  fi

  # ========== DATA ==========
  local ISP CITY DOMAIN
  [ -f /etc/xray/isp ]    && ISP="$(cat /etc/xray/isp 2>/dev/null)"
  [ -f /etc/xray/city ]   && CITY="$(cat /etc/xray/city 2>/dev/null)"
  [ -f /etc/xray/domain ] && DOMAIN="$(cat /etc/xray/domain 2>/dev/null)"

  local service="${SERVICE:-UNKNOWN}"

  # Escape HTML
  html_escape() { sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g'; }

  local ISP_E CITY_E DOMAIN_E USER_E TOTAL_E SERVICE_E
  ISP_E="$(printf '%s' "$ISP"     | html_escape)"
  CITY_E="$(printf '%s' "$CITY"    | html_escape)"
  DOMAIN_E="$(printf '%s' "$DOMAIN" | html_escape)"
  USER_E="$(printf '%s' "$user"    | html_escape)"
  TOTAL_E="$(printf '%s' "$total"   | html_escape)"
  SERVICE_E="$(printf '%s' "$service"| html_escape)"

  # ========== MESSAGE ==========
  local TEXT
  read -r -d '' TEXT <<EOF
<b>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</b>
<b>           ğŸš¨ NOTIF LIMIT QUOTA USER HABIS ğŸš¨      </b>
<b>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</b>

<pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ Service  : ${SERVICE_E}
â”‚ ğŸŒ Domain   : ${DOMAIN_E}
â”‚ âœ¨ City     : ${CITY_E}
â”‚ ğŸ· ISP      : ${ISP_E}
â”‚ ğŸ‘¤ Username : ${USER_E}
â”‚ ğŸ“Š Usage    : ${TOTAL_E}
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â° $(date "+%d-%m-%Y %H:%M:%S")
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>

<i>ğŸ¤– Notifikasi Bot Otomatis ${ADMIN}</i>
EOF

  # ========== SEND ==========
  curl -s --max-time "$TIME" \
    --data-urlencode "text=${TEXT}" \
    -d "chat_id=${CHATID}" \
    -d "parse_mode=html" \
    "$URL" >/dev/null
}

function con() {
    local -i bytes=$1;
    if [[ $bytes -lt 1024 ]]; then
        echo "${bytes}B"
    elif [[ $bytes -lt 1048576 ]]; then
        echo "$(( (bytes + 1023)/1024 ))KB"
    elif [[ $bytes -lt 1073741824 ]]; then
        echo "$(( (bytes + 1048575)/1048576 ))MB"
    else
        echo "$(( (bytes + 1073741823)/1073741824 ))GB"
    fi
}

function cekvmess(){
  data=($(cat /etc/xray/config.json | grep '^###' | cut -d ' ' -f 2 | sort | uniq))
  if [[ ! -e /etc/kyt/limit/vmess ]]; then
  mkdir -p /etc/kyt/limit/vmess
  fi
  for user in ${data[@]}
  do
  mkdir -p /tmp/quota
  data=$(xray api statsquery --server=127.0.0.1:10000 | grep -C 2 $user | sed /"}"/d | sed /"{"/d | grep value | awk '{print $2}' | sed 's/,//g; s/"//g' | sort)
  inb=$(echo "$data" | sed -n 1p)
  outb=$(echo "$data" | sed -n 2p) 
  quota0=$(echo -e "$[ $inb + $outb ]")
        if [ -e /etc/kyt/limit/vmess/${user} ]; then
        quota1=$(cat /etc/kyt/limit/vmess/${user});
             if [[ ${#quota1} -gt 0 ]]; then
                quota2=$(( ${quota0} + ${quota1} ));
                echo "${quota2}" > /etc/kyt/limit/vmess/"${user}"
                xray api stats --server=127.0.0.1:10000 -name "user>>>${user}>>>traffic>>>downlink" -reset > /dev/null 2>&1
              else
                  echo "${quota0}" > /etc/kyt/limit/vmess/"${user}"
                  xray api stats --server=127.0.0.1:10000 -name "user>>>${user}>>>traffic>>>downlink" -reset > /dev/null 2>&1
                fi
           else
               echo "${quota0}" > /etc/kyt/limit/vmess/"${user}"
               xray api stats --server=127.0.0.1:10000 -name "user>>>${user}>>>traffic>>>downlink" -reset > /dev/null 2>&1
            fi
     done
}
function cekvless(){
  data=($(cat /etc/xray/config.json | grep '^#&' | cut -d ' ' -f 2 | sort | uniq))
  if [[ ! -e /etc/kyt/limit/vless ]]; then
  mkdir -p /etc/kyt/limit/vless
  fi
  for user in ${data[@]}
  do
  mkdir -p /tmp/quota
  data=$(xray api statsquery --server=127.0.0.1:10000 | grep -C 2 $user | sed /"}"/d | sed /"{"/d | grep value | awk '{print $2}' | sed 's/,//g; s/"//g' | sort)
  inb=$(echo "$data" | sed -n 1p)
  outb=$(echo "$data" | sed -n 2p) 
  quota0=$(echo -e "$[ $inb + $outb ]")
        if [ -e /etc/kyt/limit/vless/${user} ]; then
        quota1=$(cat /etc/kyt/limit/vless/${user});
             if [[ ${#quota1} -gt 0 ]]; then
                quota2=$(( ${quota0} + ${quota1} ));
                echo "${quota2}" > /etc/kyt/limit/vless/"${user}"
                xray api stats --server=127.0.0.1:10000 -name "user>>>${user}>>>traffic>>>downlink" -reset > /dev/null 2>&1
              else
                  echo "${quota0}" > /etc/kyt/limit/vless/"${user}"
                  xray api stats --server=127.0.0.1:10000 -name "user>>>${user}>>>traffic>>>downlink" -reset > /dev/null 2>&1
                fi
           else
               echo "${quota0}" > /etc/kyt/limit/vless/"${user}"
               xray api stats --server=127.0.0.1:10000 -name "user>>>${user}>>>traffic>>>downlink" -reset > /dev/null 2>&1
            fi
     done
}
function cektrojan(){
  data=($(cat /etc/xray/config.json | grep '^#!' | cut -d ' ' -f 2 | sort | uniq))
  if [[ ! -e /etc/kyt/limit/trojan ]]; then
  mkdir -p /etc/kyt/limit/trojan
  fi
  for user in ${data[@]}
  do
  mkdir -p /tmp/quota
  data=$(xray api statsquery --server=127.0.0.1:10000 | grep -C 2 $user | sed /"}"/d | sed /"{"/d | grep value | awk '{print $2}' | sed 's/,//g; s/"//g' | sort)
  inb=$(echo "$data" | sed -n 1p)
  outb=$(echo "$data" | sed -n 2p) 
  quota0=$(echo -e "$[ $inb + $outb ]")
        if [ -e /etc/kyt/limit/trojan/${user} ]; then
        quota1=$(cat /etc/kyt/limit/trojan/${user});
             if [[ ${#quota1} -gt 0 ]]; then
                quota2=$(( ${quota0} + ${quota1} ));
                echo "${quota2}" > /etc/kyt/limit/trojan/"${user}"
                xray api stats --server=127.0.0.1:10000 -name "user>>>${user}>>>traffic>>>downlink" -reset > /dev/null 2>&1
              else
                  echo "${quota0}" > /etc/kyt/limit/trojan/"${user}"
                  xray api stats --server=127.0.0.1:10000 -name "user>>>${user}>>>traffic>>>downlink" -reset > /dev/null 2>&1
                fi
           else
               echo "${quota0}" > /etc/kyt/limit/trojan/"${user}"
               xray api stats --server=127.0.0.1:10000 -name "user>>>${user}>>>traffic>>>downlink" -reset > /dev/null 2>&1
            fi
     done
}
function vmess(){
while true; do
sleep 30
cekvmess
data=($(cat /etc/xray/config.json | grep '^###' | cut -d ' ' -f 2 | sort | uniq))
for user in ${data[@]}
do
   if [ -e /etc/vmess/${user} ]; then
     cekdulu=$(cat /etc/vmess/${user});
      if [[ ${#cekdulu} -gt 1 ]]; then
          if [ -e /etc/kyt/limit/vmess/${user} ]; then
             pakai=$(cat /etc/kyt/limit/vmess/${user});
               if [[ ${pakai} -gt ${cekdulu} ]]; then
                  exp=$(grep -w "^### $user" "/etc/xray/config.json" | cut -d ' ' -f 3 | sort | uniq)
                  sed -i "/^### $user $exp/,/^},{/d" /etc/xray/config.json
                  sed -i "/^### $user $exp/d" /etc/vmess/.vmess.db
                  systemctl restart xray >> /dev/null 2>&1
                  bol=$(cat /etc/kyt/limit/vmess/${user});
                  total=$(con ${bol})
                  SERVICE="VMESS"
                  send-log

                  rm -rf /etc/kyt/limit/vmess/${user}
              else
               echo ""
          fi
           else
            echo ""
        fi
         else
          echo ""
      fi
       else
        echo ""
    fi
  done
done
}
function vless(){
while true; do
sleep 30
cekvless
data=($(cat /etc/xray/config.json | grep '^#&' | cut -d ' ' -f 2 | sort | uniq))
for user in ${data[@]}
do
   if [ -e /etc/vless/${user} ]; then
     cekdulu=$(cat /etc/vless/${user});
      if [[ ${#cekdulu} -gt 1 ]]; then
          if [ -e /etc/kyt/limit/vless/${user} ]; then
             pakai=$(cat /etc/kyt/limit/vless/${user});
               if [[ ${pakai} -gt ${cekdulu} ]]; then
                  exp=$(grep -w "^#& $user" "/etc/xray/config.json" | cut -d ' ' -f 3 | sort | uniq)
                  sed -i "/^#& $user $exp/,/^},{/d" /etc/xray/config.json
                  sed -i "/^### $user $exp/d" /etc/vless/.vless.db
                  systemctl restart xray >> /dev/null 2>&1
                  bol=$(cat /etc/kyt/limit/vless/${user});
                  total=$(con ${bol})
                  SERVICE="VLESS"
                  send-log

                  rm -rf /etc/kyt/limit/vless/${user}
              else
               echo ""
          fi
           else
            echo ""
        fi
         else
          echo ""
      fi
       else
        echo ""
    fi
  done
done
}
function trojan(){
while true; do
sleep 30
cektrojan
data=($(cat /etc/xray/config.json | grep '^#!' | cut -d ' ' -f 2 | sort | uniq))
for user in ${data[@]}
do
   if [ -e /etc/trojan/${user} ]; then
     cekdulu=$(cat /etc/trojan/${user});
      if [[ ${#cekdulu} -gt 1 ]]; then
          if [ -e /etc/kyt/limit/trojan/${user} ]; then
             pakai=$(cat /etc/kyt/limit/trojan/${user});
               if [[ ${pakai} -gt ${cekdulu} ]]; then
                  exp=$(grep -w "^#! $user" "/etc/xray/config.json" | cut -d ' ' -f 3 | sort | uniq)
                  sed -i "/^#! $user $exp/,/^},{/d" /etc/xray/config.json
                  sed -i "/^### $user $exp/d" /etc/trojan/.trojan.db
                  systemctl restart xray >> /dev/null 2>&1
                  bol=$(cat /etc/kyt/limit/trojan/${user});
                  total=$(con ${bol})
                  SERVICE="TROJAN"
                  send-log
                  rm -rf /etc/kyt/limit/trojan/${user}
              else
               echo ""
          fi
           else
            echo ""
        fi
         else
          echo ""
      fi
       else
        echo ""
    fi
  done
done
}

if [[ ${1} == "vmess" ]]; then
vmess
elif [[ ${1} == "vless" ]]; then
vless
elif [[ ${1} == "trojan" ]]; then
trojan
fi
