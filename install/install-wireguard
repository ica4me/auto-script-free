#!/bin/bash
clear
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
WH='\033[1;37m'
NC='\033[0m'

echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${YELLOW}           MEMULAI INSTALASI WIREGUARD NAT               ${NC}"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

# 1. Deteksi Interface Publik
PUB_IF=$(ip route list default | awk '{print $5}' | head -n 1)
echo -e "${GREEN}[+]${NC} Interface publik terdeteksi: ${YELLOW}$PUB_IF${NC}"

# 2. Instalasi Paket (Menambahkan 'jq' untuk Pemrosesan JSON)
echo -e "${GREEN}[+]${NC} Menginstal WireGuard, utilitas jaringan, dan jq..."
apt update -y >/dev/null 2>&1
apt install wireguard iptables iproute2 cron jq -y >/dev/null 2>&1

# 3. Generate Kunci Server
echo -e "${GREEN}[+]${NC} Membuat Kunci Kriptografi Server..."
mkdir -p /etc/wireguard/clients
chmod 700 /etc/wireguard
wg genkey | tee /etc/wireguard/server_private.key | wg pubkey > /etc/wireguard/server_public.key
PRIV_KEY=$(cat /etc/wireguard/server_private.key)

# 4. Buat Database JSON Kosong (Struktur Baru)
echo -e "${GREEN}[+]${NC} Menyiapkan pangkalan data (database.json)..."
if [ ! -f /etc/wireguard/database.json ]; then
    echo '{"clients": {}}' > /etc/wireguard/database.json
fi
# Menghapus database lama jika sebelumnya pernah terinstall
rm -f /etc/wireguard/.wg.db 2>/dev/null

# 5. Buat Konfigurasi Dasar wg0.conf
echo -e "${GREEN}[+]${NC} Meracik konfigurasi wg0.conf (Portable Mode)..."
cat <<EOF > /etc/wireguard/wg0.conf
[Interface]
PrivateKey = $PRIV_KEY
Address = 10.11.12.1/26
ListenPort = 6001

# --- Smart Portable Routing & NAT ---
PostUp = sysctl -q -w net.ipv4.ip_forward=1
PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o $PUB_IF -j MASQUERADE
PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o $PUB_IF -j MASQUERADE

# ==========================================
# --- BLOK PORT FORWARDING & PEER CLIENT ---
# ==========================================
EOF

# 6. Start Service
echo -e "${GREEN}[+]${NC} Menyalakan service WireGuard..."
systemctl enable wg-quick@wg0 >/dev/null 2>&1
systemctl restart wg-quick@wg0 >/dev/null 2>&1

# 7. Setup Autokill Cronjob
echo -e "${GREEN}[+]${NC} Memasang penjadwal Cron untuk Autokill..."
crontab -l 2>/dev/null | grep -v "/usr/bin/autokill-wg" | crontab -
(crontab -l 2>/dev/null; echo "0 0 * * * /usr/bin/autokill-wg >/dev/null 2>&1") | crontab -

echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e " ${GREEN}✅ INSTALASI SELESAI (PORTABLE MODE + JSON READY)!${NC}"
echo -e " ${WH}Semua routing & konfigurasi hanya hidup jika wg0 ON.${NC}"
echo -e " ${WH}Server berjalan di IP 10.11.12.1/26 Port 6001.${NC}"
echo -e " ${WH}Fitur Autokill akan berjalan otomatis setiap pukul 00:00.${NC}"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
sleep 3
m-wg