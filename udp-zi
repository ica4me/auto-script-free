#!/bin/bash
# ==========================================
# Zivpn UDP Module installer - Fixed & Optimized
# PATCHED: Xray Port Exclusion, Safe DB Creation
# ==========================================

# Fix for sudo: unable to resolve host
HOSTNAME=$(hostname)
if ! grep -q "127.0.0.1 $HOSTNAME" /etc/hosts; then
    echo "Adding $HOSTNAME to /etc/hosts"
    sudo bash -c "echo '127.0.0.1 $HOSTNAME' >> /etc/hosts"
fi

echo -e "Updating server & Installing Dependencies..."
sudo apt-get update -y
sudo apt-get install -y ufw jq curl figlet iptables-persistent

if ! command -v lolcat &> /dev/null; then
    echo "lolcat not found, installing..."
    sudo apt-get install -y ruby-full
    sudo gem install lolcat
fi

# Stop service kalau ada
sudo systemctl stop zivpn.service > /dev/null 2>&1

echo -e "Downloading UDP Service"
sudo mkdir -p /etc/zivpn
sudo wget -q https://raw.githubusercontent.com/ica4me/auto-script-free/main/udpzi/udp-zivpn-linux-amd64 -O /usr/local/bin/zivpn-bin
sudo chmod +x /usr/local/bin/zivpn-bin
sudo wget -q https://raw.githubusercontent.com/ica4me/auto-script-free/main/udpzi/config.json -O /etc/zivpn/config.json

echo "Generating cert files:"
sudo openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 -subj "/C=US/ST=California/L=Los Angeles/O=Example Corp/OU=IT Department/CN=zivpn" -keyout "/etc/zivpn/zivpn.key" -out "/etc/zivpn/zivpn.crt" 2>/dev/null

sudo sysctl -w net.core.rmem_max=16777216 > /dev/null
sudo sysctl -w net.core.wmem_max=16777216 > /dev/null

# Create SystemD Service
sudo bash -c 'cat <<EOF > /etc/systemd/system/zivpn.service
[Unit]
Description=zivpn VPN Server
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/etc/zivpn
ExecStart=/usr/local/bin/zivpn-bin server -c /etc/zivpn/config.json
Restart=always
RestartSec=3
Environment=ZIVPN_LOG_LEVEL=info
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
NoNewPrivileges=true

[Install]
WantedBy=multi-user.target
EOF'

# --- PATCH: Aman dari Data Wipe Out ---
if [ ! -s /etc/zivpn/users.db.json ]; then
    sudo bash -c 'echo "[]" > /etc/zivpn/users.db.json'
fi
if [ ! -s /etc/zivpn/theme.conf ]; then
    sudo bash -c 'echo "rainbow" > /etc/zivpn/theme.conf'
fi

# --- PATCH: Sinkronisasi Iptables ZIVPN vs Xray ---
echo -e "Configuring Firewall Routing..."
INTERFACE=$(ip -4 route ls | grep default | grep -Po '(?<=dev )(\S+)' | head -1)

# Hapus rule lama agar tidak duplikat
sudo iptables -t nat -D PREROUTING -i $INTERFACE -p udp --dport 6000:19999 -j DNAT --to-destination :5667 2>/dev/null || true
sudo iptables -t nat -D PREROUTING -p udp --dport 10000:10008 -j RETURN 2>/dev/null || true

# Tambahkan Rule Baru (Urutan Menentukan Prioritas!)
# 1. Alihkan port 6000-19999 ke ZIVPN (5667)
sudo iptables -t nat -I PREROUTING 1 -p udp --dport 6000:19999 -j DNAT --to-destination :5667
# 2. Kecualikan port XRAY (10000-10008) agar TIDAK ikut dialihkan ke ZIVPN
sudo iptables -t nat -I PREROUTING 1 -p udp --dport 10000:10008 -j RETURN

sudo iptables -A FORWARD -p udp -d 127.0.0.1 --dport 5667 -j ACCEPT
sudo iptables -t nat -A POSTROUTING -s 127.0.0.1/32 -o $INTERFACE -j MASQUERADE
sudo netfilter-persistent save > /dev/null

# Start Services
sudo systemctl daemon-reload
sudo systemctl enable zivpn.service
sudo systemctl start zivpn.service
sudo ufw allow 6000:19999/udp > /dev/null
sudo ufw allow 5667/udp > /dev/null

# Download Eksternal Scripts
sudo wget -q -O /usr/local/bin/zivpn https://raw.githubusercontent.com/ica4me/auto-script-free/main/udpzi/zivpn-menu.sh
sudo chmod +x /usr/local/bin/zivpn

sudo wget -q -O /usr/local/bin/uninstall.sh https://raw.githubusercontent.com/ica4me/auto-script-free/main/udpzi/uninstall.sh
sudo chmod +x /usr/local/bin/uninstall.sh

sudo wget -q -O /usr/local/bin/zivpn-cleanup.sh https://raw.githubusercontent.com/ica4me/auto-script-free/main/udpzi/zivpn-cleanup.sh
sudo chmod +x /usr/local/bin/zivpn-cleanup.sh

sudo wget -q -O /usr/local/bin/zivpn-autobackup.sh https://raw.githubusercontent.com/wibuidc/zivpn-udp/main/zivpn-autobackup.sh
sudo chmod +x /usr/local/bin/zivpn-autobackup.sh

# Cronjob Cleanup
sudo bash -c 'echo "* * * * * root /usr/local/bin/zivpn-cleanup.sh" > /etc/cron.d/zivpn-cleanup'

# Get Public IP
IP_ADDRESS=$(curl -sS ifconfig.me || hostname -I | awk '{print $1}')

# Display Welcome Message
clear
if command -v lolcat &> /dev/null; then
    figlet -f standard "ZIVPN" | lolcat
    echo -e "============================================" | lolcat
    echo -e "            ZIVPN MANAGER - v1.5            " | lolcat
    echo -e "============================================" | lolcat
else
    echo "============================================"
    echo "            ZIVPN MANAGER - v1.5            "
    echo "============================================"
fi

echo -e "\033[1;37mServer IP Address: ${IP_ADDRESS}\033[0m"
echo -e "\033[1;37mRun the command 'zivpn' to access the panel.\033[0m"
echo -e "\033[1;33mContact us on Telegram (@Deki_niswara) for support.\033[0m"
echo ""

# Cleanup installation file
rm -f zi-fixed.sh* udp-zi* > /dev/null 2>&1